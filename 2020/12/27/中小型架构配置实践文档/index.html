<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>中小型架构配置实践文档 | Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/12/27/%E4%B8%AD%E5%B0%8F%E5%9E%8B%E6%9E%B6%E6%9E%84%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5%E6%96%87%E6%A1%A3/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E6%9E%B6%E6%9E%84%E4%B8%8E%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">一. 架构与需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">二. 数据库服务器部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">三. web 服务器部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">4.</span> <span class="toc-text">四. 存储服务器部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">五. 负载均衡服务器部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">6.</span> <span class="toc-text">六. 备份服务器部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E4%B8%80%E4%B8%AA%E7%BD%91%E7%AB%99"><span class="toc-number">7.</span> <span class="toc-text">新增一个网站</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/12/27/%E4%B8%AD%E5%B0%8F%E5%9E%8B%E6%9E%B6%E6%9E%84%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5%E6%96%87%E6%A1%A3/">中小型架构配置实践文档</a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-12-27 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-28 </span><span><v-icon color="">folder</v-icon>In:&nbsp;<a class="category-link" href="/categories/Linux/">Linux</a> </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h3 id="一-架构与需求"><a href="#一-架构与需求" class="headerlink" title="一. 架构与需求"></a>一. 架构与需求</h3><p><strong>架构图</strong></p><p><img src="https://zeuslb.github.io/img/%E4%B8%AD%E5%B0%8F%E5%9E%8B%E4%BC%81%E4%B8%9A%E5%AE%9E%E8%B7%B5%E6%9E%B6%E6%9E%84%E8%A7%84%E5%88%92%E5%9B%BE.png" alt="中小型企业实践架构规划图"></p><p><strong>需求</strong></p><ol><li>基础功能：搭建 wordpress 网站。</li><li>架构：LNMP 架构</li></ol><h3 id="二-数据库服务器部署"><a href="#二-数据库服务器部署" class="headerlink" title="二. 数据库服务器部署"></a>二. 数据库服务器部署</h3><p><strong>mariadb 服务部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装 mariadb 相关软件并启动服务</span></span><br><span class="line">[root@db01 ~]# yum install mariadb-server mariadb -y</span><br><span class="line">[root@db01 ~]# systemctl start mariadb.service </span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 为 root 用户设置密码，并进行测试</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot password &quot;root&quot;</span><br><span class="line">[root@db01 ~]# mysql -uroot -proot</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 关闭 dns 解析功能</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve # 新增该指令</span><br><span class="line">[root@db01 ~]# systemctl restart mariadb.service</span><br><span class="line">[root@db01 ~]# mysql -uroot -proot</span><br><span class="line">MariaDB [(none)]&gt; show variables like &quot;%skip%&quot;; # skip_name_resolve = ON 即为配置成功</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 创建网站所用的db，并创建管理该站点数据库的用户</span></span><br><span class="line">MariaDB [(none)]&gt; create database wq_db;</span><br><span class="line">MariaDB [(none)]&gt; grant all on wq_db.* to wq_root@&quot;10.0.0.%&quot; identified by &quot;wq_root&quot;;</span><br><span class="line">MariaDB [(none)]&gt; select user,host from mysql.user;</span><br></pre></td></tr></table></figure><h3 id="三-web-服务器部署"><a href="#三-web-服务器部署" class="headerlink" title="三. web 服务器部署"></a>三. web 服务器部署</h3><p><strong>nginx 服务部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> web01、web02、web03 操作均相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 更改官方源</span></span><br><span class="line">[root@web01 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 下载 nginx 软件</span></span><br><span class="line">[root@web01 ~]# yum install -y nginx</span><br><span class="line">[root@web01 ~]# nginx -v</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建站点目录</span></span><br><span class="line">[root@web01 ~]# mkdir /html/wq -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 创建站点管理用户，修改属主属组</span></span><br><span class="line">[root@web01 ~]# cat /etc/passwd | grep 1000</span><br><span class="line">[root@web01 ~]# useradd www -u 1000 -M -s /sbin/nologin</span><br><span class="line">[root@web01 ~]# chown www. /html/wq/ -R</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 修改配置文件</span></span><br><span class="line">[root@web01 ~]# mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bak</span><br><span class="line">[root@web01 ~]# vim /etc/nginx/conf.d/wq.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.wq.com;</span><br><span class="line">    error_log  /var/log/nginx/wq_error.log warn;</span><br><span class="line">    access_log  /var/log/nginx/wq_access.log main;</span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line">    location / &#123;</span><br><span class="line">		root /html/wq/;</span><br><span class="line">		index index.php;</span><br><span class="line">    &#125;</span><br><span class="line">    location /basic_status &#123;</span><br><span class="line">		stub_status;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">		root /html/wq/;</span><br><span class="line">		fastcgi_index index.php;</span><br><span class="line">		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">		fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">		include fastcgi_params;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 ~]# vim /etc/nginx/nginx.conf </span><br><span class="line">user www;</span><br><span class="line">worker_processes 1;</span><br><span class="line"><span class="meta">#</span><span class="bash">error_log /var/<span class="built_in">log</span>/nginx/error.log warn;</span></span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    #access_log /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile on;</span><br><span class="line">    #tcp_nopush on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    #gzip on;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. 检查配置文件并重启服务</span></span><br><span class="line">[root@web01 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@web01 ~]# systemctl restart nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 7. 上传网站代码</span></span><br><span class="line">[root@web01 ~]# cd /html/wq/</span><br><span class="line">[root@web01 wq]# rz -E</span><br><span class="line">rz waiting to receive.</span><br><span class="line">[root@web01 wq]# ll /html/wq/</span><br><span class="line">total 15712</span><br><span class="line">-rw-r--r-- 1 root root 16087243 Dec 22 15:07 wordpress-5.6-zh_CN.tar.gz</span><br><span class="line">[root@web01 wq]# tar xf wordpress-5.6-zh_CN.tar.gz</span><br><span class="line">[root@web01 wq]# ll</span><br><span class="line">total 15716</span><br><span class="line">drwxr-xr-x 5 1006 1006     4096 Dec 20 19:00 wordpress</span><br><span class="line">-rw-r--r-- 1 root root 16087243 Dec 22 15:07 wordpress-5.6-zh_CN.tar.gz</span><br><span class="line">[root@web01 wq]# mv ./wordpress/* ./</span><br><span class="line"><span class="meta">#</span><span class="bash"> 8. 更改属主属组</span></span><br><span class="line">[root@web01 wq]# chown www. /html -R</span><br><span class="line"><span class="meta">#</span><span class="bash"> 9. 配置 windows 主机模拟解析环境</span></span><br><span class="line">C:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure><p><strong>php 服务部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 优化下载源</span></span><br><span class="line">[root@web01 ~]# rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">[root@web01 ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 下载 php 软件服务与依赖</span></span><br><span class="line">[root@web01 ~]# yum remove php-mysql php php-fpm php-common</span><br><span class="line">[root@web01 ~]# yum install -y php71w php71w-cli php71w-common php71w-devel php71w-embedded  php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache  php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编辑配置文件 /etc/php-fpm.d/www.conf</span></span><br><span class="line">[root@web01 ~]# vim /etc/php-fpm.d/www.conf</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000; # 默认</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 编辑配置文件 /etc/php.ini</span></span><br><span class="line">[root@web01 ~]# vim /etc/php.ini</span><br><span class="line">post_max_size = 100M</span><br><span class="line">upload_max_filesize = 100M</span><br></pre></td></tr></table></figure><h3 id="四-存储服务器部署"><a href="#四-存储服务器部署" class="headerlink" title="四. 存储服务器部署"></a>四. 存储服务器部署</h3><p><strong>nfs 服务部署 - 10.0.0.31</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装 nfs 软件</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建相应的存储目录</span></span><br><span class="line">[root@nfs01 ~]# mkdir /data/web/wq_site -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建目录管理用户，并更改目录的属主和属组</span></span><br><span class="line">[root@nfs01 ~]# cat /etc/passwd | grep 1000</span><br><span class="line">[root@nfs01 ~]# useradd www -u 1000 -M -s /sbin/nologin</span><br><span class="line">[root@nfs01 ~]# chown www. /data/web/ -R</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 更改配置文件</span></span><br><span class="line">[root@nfs01 ~]# vim /etc/exports</span><br><span class="line">/data/web/wq_site 10.0.0.0/24(rw,sync,anonuid=1000,anongid=1000)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 重启服务</span></span><br><span class="line">[root@nfs01 ~]# systemctl restart nfs.service</span><br></pre></td></tr></table></figure><p><strong>nfs 服务部署 - web 服务器</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装 nfs 软件</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 备份数据</span></span><br><span class="line">[root@web01 ~]# mv /html/wq/wp-content/uploads/* /tmp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 挂载</span></span><br><span class="line">[root@web01 ~]# mount -t nfs 10.0.0.31:/data/web/wq_site /html/wq/wp-content/uploads/</span><br><span class="line">[root@web01 ~]# df -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 还原数据</span></span><br><span class="line">[root@web01 ~]# mv /tmp/2020/ /html/wq/wp-content/uploads</span><br></pre></td></tr></table></figure><p><strong>网站功能测试</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. nfs 配置功能测试</span></span><br><span class="line">[root@nfs01 ~]# ll /data/web/wq_site/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 3 www www 16 Dec 27 10:31 2020</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 访问：10.0.0.7/wp-admin 测试 web01 功能(发布文章，包含图片)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 访问：10.0.0.8/wp-admin 测试 web02 功能(发布文章，包含图片)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 访问：10.0.0.9/wp-admin 测试 web03 功能(发布文章，包含图片)</span></span><br></pre></td></tr></table></figure><h3 id="五-负载均衡服务器部署"><a href="#五-负载均衡服务器部署" class="headerlink" title="五. 负载均衡服务器部署"></a>五. 负载均衡服务器部署</h3><p><strong>负载均衡功能配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lb01、lb02 操作均相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 更改官方源</span></span><br><span class="line">[root@lb01 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 下载 nginx 软件</span></span><br><span class="line">[root@lb01 ~]# yum install -y nginx</span><br><span class="line">[root@lb01 ~]# nginx -v</span><br><span class="line">[root@lb01 ~]# mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bak</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编写配置文件</span></span><br><span class="line">[root@lb01 ~]# vim /etc/nginx/conf.d/proxy.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://web;</span><br><span class="line">		proxy_set_header Host $host; </span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">upstream web &#123; </span><br><span class="line">    server 10.0.0.7:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">    server 10.0.0.8:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">    server 10.0.0.9:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 重启服务</span></span><br><span class="line">[root@lb01 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@lb01 ~]# systemctl restart nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 测试负载均衡是否成功</span></span><br><span class="line">[root@web01 ~]# echo &quot;web01 index.html&quot; &gt; /html/wq/index.html</span><br><span class="line">[root@web02 ~]# echo &quot;web02 index.html&quot; &gt; /html/wq/index.html</span><br><span class="line">[root@web03 ~]# echo &quot;web03 index.html&quot; &gt; /html/wq/index.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 浏览器输入 10.0.0.5/index.html 和 10.0.0.6/index.html</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停掉web01-03任一一台服务器的 nginx 服务，继续访问测试</span></span><br></pre></td></tr></table></figure><p><strong>nginx 日志切割时间结尾配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# vim /etc/logrotate.d/nginx</span><br><span class="line">dateext # 新增</span><br><span class="line">[root@web01 ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure><p><strong>nginx 服务优化配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lb01、lb02 操作均相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 编辑配置文件 → 在 location / &#123;&#125; 中新增</span></span><br><span class="line">[root@lb02 ~]# vim /etc/nginx/conf.d/proxy.conf</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_connect_timeout 20s;</span><br><span class="line">    proxy_send_timeout 60s;</span><br><span class="line">    proxy_read_timeout 60s;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffer_size 8k;</span><br><span class="line">    proxy_buffers 8 4k;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 重启服务</span></span><br><span class="line">[root@lb01 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@lb01 ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure><p><strong>nginx cache 缓存功能配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lb01、lb02 操作均相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建缓存目录并挂载</span></span><br><span class="line">[root@lb01 ~]# mkdir /tmp/nginx_cache</span><br><span class="line">[root@lb01 ~]# mount -t tmpfs -o size=100M tmpfs /tmp/nginx_cache</span><br><span class="line">[root@lb01 ~]# df -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 编辑配置文件</span></span><br><span class="line">[root@lb01 ~]# vim /etc/nginx/conf.d/proxy.conf</span><br><span class="line">proxy_cache_path /tmp/nginx_cache levels=2:1 keys_zone=cache_one:100m inactive=1d max_size=5g;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://web;</span><br><span class="line">    	proxy_set_header Host $host;</span><br><span class="line">    	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    	proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429;</span><br><span class="line">    	</span><br><span class="line">    	proxy_connect_timeout 20s;</span><br><span class="line">    	proxy_send_timeout 60s;</span><br><span class="line">    	proxy_read_timeout 60s;</span><br><span class="line">    	proxy_buffering on;</span><br><span class="line">    	proxy_buffer_size 8k;</span><br><span class="line">    	proxy_buffers 8 4k;</span><br><span class="line">    	</span><br><span class="line">    	proxy_cache cache_one;</span><br><span class="line">        proxy_cache_valid 200 304 12h;</span><br><span class="line">        proxy_cache_valid 301 302 1m;</span><br><span class="line">        proxy_cache_valid any 1m;</span><br><span class="line">        proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">        add_header X-Cache-Status $upstream_cache_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">upstream web &#123;</span><br><span class="line">    server 10.0.0.7:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">    server 10.0.0.8:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">    server 10.0.0.9:80 max_fails=2 fail_timeout=3s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. cache 缓存功能测试：多次刷新页面，F12 查看响应头 → X-Cache-Status: HIT</span></span><br><span class="line">[root@lb01 ~]# rm -rf /tmp/nginx_cache/*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除缓存后刷新页面</span></span><br><span class="line">[root@lb02 ~]# rm -rf /tmp/nginx_cache/*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除缓存后刷新页面</span></span><br></pre></td></tr></table></figure><p><strong>高可用功能配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lb01、lb02 操作大致相同</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装 keepalived 软件</span></span><br><span class="line">[root@lb01 ~]# yum install -y keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 编辑配置文件</span></span><br><span class="line">[root@lb01 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	priority 150</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.3</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@lb02 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id lb02</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state BACKUP</span><br><span class="line">   interface eth0</span><br><span class="line">   virtual_router_id 51</span><br><span class="line">   priority 100</span><br><span class="line">   advert_int 1</span><br><span class="line">   authentication &#123;</span><br><span class="line">	   auth_type PASS</span><br><span class="line">	   auth_pass 1111</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">	   10.0.0.3</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 启动服务</span></span><br><span class="line">systemctl start keepalived.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 配置域名映射 C:\Windows\system32\drivers\etc\hosts</span></span><br><span class="line">10.0.0.3 www.wq.com</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 测试服务是否正常</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 wireshark 抓包 (vrrp协议)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭一台负载服务器的keepalived服务，访问 www.wq.com 确认是否可以正常切换</span></span><br></pre></td></tr></table></figure><h3 id="六-备份服务器部署"><a href="#六-备份服务器部署" class="headerlink" title="六. 备份服务器部署"></a>六. 备份服务器部署</h3><p><strong>备份服务器 rsync 部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装软件</span></span><br><span class="line">[root@backup ~]# yum install -y rsync</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建管理用户、目录、更改属主、创建密码文件、改权限为600</span></span><br><span class="line">[root@backup ~]# useradd rsync -M -s /sbin/nologin</span><br><span class="line">[root@backup ~]# mkdir /backup/&#123;nfs,web,lb&#125; -p</span><br><span class="line">[root@backup ~]# chown rsync. /backup -R</span><br><span class="line">[root@backup ~]# echo -e &#x27;nfs:nfs\nweb:web\nlb:lb&#x27; &gt; /etc/rsync.password</span><br><span class="line">[root@backup ~]# chmod 600 /etc/rsync.password</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编写配置文件</span></span><br><span class="line">[root@backup ~]# vim /etc/rsyncd.conf</span><br><span class="line">uid = rsync</span><br><span class="line">gid = rsync</span><br><span class="line">port = 873</span><br><span class="line">fake super = yes</span><br><span class="line">use chroot = no</span><br><span class="line">max connections = 200</span><br><span class="line">timeout = 300</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file = /var/run/rsync.lock</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">ignore errors</span><br><span class="line">read only = false</span><br><span class="line">list = false</span><br><span class="line">hosts allow = 10.0.0.0/24</span><br><span class="line">hosts deny = 0.0.0.0/32</span><br><span class="line">secrets file = /etc/rsync.password</span><br><span class="line">[web_bak]</span><br><span class="line">auth users = web</span><br><span class="line">comment = &quot;web backup&quot;</span><br><span class="line">path = /backup/web/</span><br><span class="line">[nfs_bak]</span><br><span class="line">auth users = nfs</span><br><span class="line">comment = &quot;nfs backup&quot;</span><br><span class="line">path = /backup/nfs/</span><br><span class="line">[lb_bak]</span><br><span class="line">auth users = lb</span><br><span class="line">comment = &quot;lb backup&quot;</span><br><span class="line">path = /backup/lb/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动服务</span></span><br><span class="line">[root@backup ~]# systemctl start rsyncd</span><br></pre></td></tr></table></figure><p><strong>存储服务器 sersync 部署</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建密码文件</span></span><br><span class="line">[root@nfs01 ~]# echo nfs &gt; /etc/rsync.pas</span><br><span class="line">[root@nfs01 ~]# chmod 600 /etc/rsync.pas</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 下载 sersync 并安装</span></span><br><span class="line">[root@nfs01 ~]# wget https://github.com/wsgzao/sersync/archive/master.zip</span><br><span class="line">[root@nfs01 ~]# unzip master.zip</span><br><span class="line">[root@nfs01 ~]# cd sersync-master/</span><br><span class="line">[root@nfs01 sersync-master]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br><span class="line">[root@nfs01 sersync-master]# mv GNU-Linux-x86/ /usr/local/sersync/</span><br><span class="line">[root@nfs01 sersync-master]# vim /etc/profile</span><br><span class="line">export PATH=&quot;/usr/local/sersync/:$PATH&quot;</span><br><span class="line">[root@nfs01 sersync-master]# . /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编辑配置文件</span></span><br><span class="line">[root@nfs01 sersync-master]# vim /usr/local/sersync/confxml.xml</span><br><span class="line">&lt;localpath watch=&quot;/data/&quot;&gt;</span><br><span class="line">	&lt;remote ip=&quot;10.0.0.41&quot; name=&quot;nfs_bak&quot;/&gt;</span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">&lt;rsync&gt;</span><br><span class="line">	&lt;commonParams params=&quot;-az&quot;/&gt;</span><br><span class="line">	&lt;auth start=&quot;true&quot; users=&quot;nfs&quot; passwordfile=&quot;/etc/rsync.pas&quot;/&gt;</span><br><span class="line">	&lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt;&lt;!-- port=874 --&gt;</span><br><span class="line">	&lt;timeout start=&quot;false&quot; time=&quot;100&quot;/&gt;&lt;!-- timeout=100 --&gt;</span><br><span class="line">	&lt;ssh start=&quot;false&quot;/&gt;</span><br><span class="line">&lt;/rsync&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动服务</span></span><br><span class="line">[root@nfs01 sersync-master]# sersync2 -dro /usr/local/sersync/confxml.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 测试实时备份功能</span></span><br><span class="line">[root@nfs01 sersync-master]# touch /data/test.txt</span><br><span class="line">[root@backup ~]# ll /backup/nfs/</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 rsync rsync  0 Dec 27 15:57 test.txt</span><br><span class="line">drwxr-xr-x 3 rsync rsync 21 Dec 25 20:06 web</span><br></pre></td></tr></table></figure><p><strong>备份服务器邮件服务配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 编辑配置文件</span></span><br><span class="line">[root@backup ~]# vim /etc/mail.rc</span><br><span class="line">set from=714616622@qq.com</span><br><span class="line">set smtp=smtp.qq.com</span><br><span class="line">set smtp-auth-user=714616622@qq.com</span><br><span class="line">set smtp-auth-password=abftwbzzphewbeah</span><br><span class="line">set smtp-auth=login</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 重启服务</span></span><br><span class="line">systemctl restart postfix.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 测试邮件功能</span></span><br><span class="line">echo &quot;xxx&quot; | mail -s &quot;标题&quot; 714616622@qq.com</span><br></pre></td></tr></table></figure><p><strong>web 服务器备份配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建密码文件</span></span><br><span class="line">[root@web01 ~]# echo web &gt; /etc/rsync.pas</span><br><span class="line">[root@web01 ~]# chmod 600 /etc/rsync.pas</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建脚本目录</span></span><br><span class="line">[root@web01 ~]# mkdir /scripts</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建脚本并编写</span></span><br><span class="line">[root@web01 ~]# vim /scripts/web_backup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> RSYNC_PASSWORD=web</span></span><br><span class="line">date_info=$(date &quot;+%F_%A&quot; -d &quot;-1 day&quot;) # 备份时间信息</span><br><span class="line">bak_dir=&quot;/backup/web/$(/usr/sbin/ip a s eth1 | awk -F &quot;[ /]+&quot; &#x27;NR==3&#123;print $3&#125;&#x27;)&quot; # 备份目标目录(后面不加/的原因是需要在rsync备份时将目录及其子文件传输)</span><br><span class="line">bak_system_data=&quot;/etc/profile /etc/fstab /etc/php-fpm.d/www.conf /etc/php.ini /etc/exports /etc/logrotate.d/nginx /etc/keepalived/keepalived.conf /etc/nginx/nginx.conf /etc/nginx/conf.d/&quot; # 备份数据列表(系统文件)</span><br><span class="line">bak_web_code=&quot;/html/&quot; # 备份数据列表(代码文件)</span><br><span class="line">bak_web_log=&quot;/var/log/nginx/&quot; # 备份数据列表(日志文件)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建目录</span></span><br><span class="line">if [ ! -d $bak_dir ]</span><br><span class="line">then</span><br><span class="line">    mkdir -p $bak_dir</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 压缩数据</span></span><br><span class="line">tar zcfh $bak_dir/system_data_$&#123;date_info&#125;.tar.gz $bak_system_data</span><br><span class="line">tar zcfh $bak_dir/web_code_$&#123;date_info&#125;.tar.gz $bak_web_code</span><br><span class="line">tar zcfh $bak_dir/web_log_$&#123;date_info&#125;.tar.gz $bak_web_log &amp;&gt; /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除七天前的数据</span></span><br><span class="line">find $bak_dir -type f -name &quot;*.tar.gz&quot; -mtime +7 -delete</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据校验</span></span><br><span class="line">find $bak_dir -type f -name &quot;*.tar.gz&quot; -mmin -200 | xargs md5sum &gt; $bak_dir/check.pw</span><br><span class="line"><span class="meta">#</span><span class="bash"> rsync 备份</span></span><br><span class="line">rsync -az $bak_dir web@10.0.0.41::web_bak --password-file=/etc/rsync.pas</span><br></pre></td></tr></table></figure><p><strong>备份服务器代码</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建脚本目录</span></span><br><span class="line">[root@backup ~]# mkdir /scripts</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建脚本并编写</span></span><br><span class="line">[root@backup ~]# vim /scripts/backup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据完整性校验</span></span><br><span class="line">find /backup -type f -name &quot;check.pw&quot; | xargs md5sum -c &gt; /var/log/Integrity_check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 邮件发送</span></span><br><span class="line">mail -s &quot;备份数据日志&quot; 714616622@qq.com &lt; /var/log/Integrity_check</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保留每周一的所有数据副本，其他保留6个月的数据副本</span></span><br><span class="line">find /backup -type f ! -name &quot;*Monday.tar.gz&quot; -mtime +180 -name -delete</span><br></pre></td></tr></table></figure><p><strong>配置定时任务</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# crontab -e</span><br><span class="line">00 18 * * * /bin/sh /scripts/web_backup.sh &amp;&gt; /dev/null</span><br><span class="line">[root@backup ~]# crontab -e</span><br><span class="line">01 18 * * * /bin/sh /scripts/backup.sh &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure><h3 id="新增一个网站"><a href="#新增一个网站" class="headerlink" title="新增一个网站"></a>新增一个网站</h3><p><strong>mariadb 配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 登录</span></span><br><span class="line">[root@db01 ~]# mysql -uroot -proot</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建网站所用的db，并创建管理该站点数据库的用户</span></span><br><span class="line">MariaDB [(none)]&gt; create database wecenter_db;</span><br><span class="line">MariaDB [(none)]&gt; grant all on wecenter_db.* to wc_root@&quot;10.0.0.%&quot; identified by &quot;wc_root&quot;;</span><br><span class="line">MariaDB [(none)]&gt; select user,host from mysql.user;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拓展</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除数据库</span></span><br><span class="line">MariaDB [(none)]&gt; drop database typecho_db;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除用户</span></span><br><span class="line">MariaDB [(none)]&gt; drop user ty_root@&quot;10.0.0.%&quot;;</span><br></pre></td></tr></table></figure><p><strong>web 服务器配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 网站代码上传、更改属主、编写配置文件、重启nginx服务</span></span><br><span class="line">[root@web01 ~]# mkdir /html/wc</span><br><span class="line">[root@web01 ~]# cd /html/wc</span><br><span class="line">[root@web01 wc]# rz -y</span><br><span class="line">[root@web01 wc]# ll</span><br><span class="line">total 24044</span><br><span class="line">-rw-r--r-- 1 root root 24618118 Dec 23 10:33 WeCenter_3-6-0.zip</span><br><span class="line">[root@web01 wc]# unzip WeCenter_3-6-0.zip</span><br><span class="line">[root@web01 wc]# chown www. /html -R</span><br><span class="line">[root@web01 ~]# cp -a /etc/nginx/conf.d/wq.conf /etc/nginx/conf.d/wc.conf</span><br><span class="line">[root@web01 ~]# vim /etc/nginx/conf.d/wc.conf</span><br><span class="line">[root@web01 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@web01 ~]# systemctl restart nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 网站输入10.0.0.7进行网站初始化配置  10.0.0.51 wecenter_db wc_root wc_root</span></span><br></pre></td></tr></table></figure><p><strong>nfs 服务配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 ~]# vim /etc/exports</span><br><span class="line">/data/web/wq_site 10.0.0.0/24(rw,sync,anonuid=1000,anongid=1000)</span><br><span class="line">/data/web/wc_site 10.0.0.0/24(rw,sync,anonuid=1000,anongid=1000)</span><br><span class="line">[root@nfs01 ~]# systemctl restart nfs</span><br><span class="line">[root@web01 wc]# mv /html/wc/uploads/* /tmp</span><br><span class="line"></span><br><span class="line">[root@web02 ~]# scp -rp 10.0.0.7:/html/wc /html</span><br><span class="line">[root@web03 ~]# scp -rp 10.0.0.7:/html/wc /html</span><br><span class="line"></span><br><span class="line">[root@web01 wc]# mount -t nfs 10.0.0.31:/data/web/wc_site /html/wc/uploads</span><br><span class="line">[root@web01 wc]# df -h</span><br><span class="line">[root@web01 wc]# mv /tmp/article/ /html/wc/uploads</span><br></pre></td></tr></table></figure><p><strong>配置高可用 - 双主配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id lb01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">     &#125;</span><br><span class="line">     virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.4</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 ~]# systemctl restart keepalived.service</span><br><span class="line">[root@lb02 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id lb02</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state BACKUP</span><br><span class="line">   interface eth0</span><br><span class="line">   virtual_router_id 51</span><br><span class="line">   priority 100</span><br><span class="line">   advert_int 1</span><br><span class="line">   authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">   		10.0.0.3</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">   	state MASTER</span><br><span class="line">   	interface eth0</span><br><span class="line">   	virtual_router_id 52</span><br><span class="line">   	priority 150</span><br><span class="line">   	advert_int 1</span><br><span class="line">   	authentication &#123;</span><br><span class="line">   		auth_type PASS</span><br><span class="line">   		auth_pass 1111</span><br><span class="line">   	&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">   		10.0.0.4</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb02 ~]# systemctl restart keepalived.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置本地DNS解析</span></span><br><span class="line">10.0.0.3 www.wq.com</span><br><span class="line">10.0.0.4 www.wc.com</span><br></pre></td></tr></table></figure><p><strong>配置高可用 - 监控 nginx 服务配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# mkdir /scripts/</span><br><span class="line">[root@lb01 ~]# vim /scripts/check_ngx.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">if [ ! -f /var/run/nginx.pid ]</span><br><span class="line">then</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">[root@lb01 ~]# chmod +x /scripts/check_ngx.sh</span><br><span class="line">[root@lb01 ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id lb01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">	script &quot;/scripts/check_ngx.sh&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight -60</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	priority 150</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.3</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		check_nginx</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 52</span><br><span class="line">	priority 100</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.4</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 ~]# systemctl restart keepalived.service</span><br><span class="line"></span><br><span class="line">[root@lb02 ~]# scp -pr 10.0.0.5:/scripts /</span><br><span class="line">[root@lb02 ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id lb02</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script check_nginx &#123; </span><br><span class="line">        script &quot;/scripts/check_ngx.sh&quot;</span><br><span class="line">        interval 2 </span><br><span class="line">        weight -60 </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state BACKUP</span><br><span class="line">   interface eth0</span><br><span class="line">   virtual_router_id 51</span><br><span class="line">   priority 100</span><br><span class="line">   advert_int 1</span><br><span class="line">   authentication &#123;</span><br><span class="line">	   auth_type PASS</span><br><span class="line">	   auth_pass 1111</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">	   10.0.0.3</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">   state MASTER</span><br><span class="line">   interface eth0</span><br><span class="line">   virtual_router_id 52</span><br><span class="line">   priority 150</span><br><span class="line">   advert_int 1</span><br><span class="line">   authentication &#123;</span><br><span class="line">	   auth_type PASS</span><br><span class="line">	   auth_pass 1111</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">	   10.0.0.4</span><br><span class="line">   &#125;</span><br><span class="line">   track_script &#123;</span><br><span class="line">	check_nginx</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb02 ~]# systemctl restart keepalived.service</span><br></pre></td></tr></table></figure></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/12/25/%E9%AB%98%E5%8F%AF%E7%94%A8%20keepalived%20%E9%83%A8%E7%BD%B2/">高可用 keepalived 部署</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hibiki.model.json"},display:{position:"right",width:145,height:315},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html>