<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>NFS 服务部署 | Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/12/14/NFS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E5%88%9D%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">一. 存储服务初识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-NFS-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">二. NFS 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-NFS-%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">三. NFS 部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-NFS-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%8E%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">四. NFS 配置文件与配置参数详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="toc-number">5.</span> <span class="toc-text">五. 错误排查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-NFS-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">六. NFS 存储服务常见问题说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-%E6%9B%B4%E5%A4%9A%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">七. 更多参考资料</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/12/14/NFS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/">NFS 服务部署</a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-12-14 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-14 </span><span><v-icon color="">folder</v-icon>In:&nbsp;<a class="category-link" href="/categories/Linux/">Linux</a> </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h3 id="一-存储服务初识"><a href="#一-存储服务初识" class="headerlink" title="一. 存储服务初识"></a>一. 存储服务初识</h3><p><strong>NFS 存储服务概念说明</strong></p><p>NFS 是 Network File System 的缩写，即网络文件系统，其主要功能是通过网络 (一般为局域网) 让不同的主机之间可以共享文件或目录。</p><p>NFS 客户端 (一般为应用服务器，例如 web) 可以通过挂载 (mount) 的方式将 NFS 服务端共享的数据目录挂载到 NFS 客户端本地系统中。从客户端本地看，NFS 服务器端共享的目录就好像是客户端自己的磁盘分区或者目录一样，但实际访问的是 NFS 服务器的目录。</p><p>第一个网络文件系统被称为 File Access Listener，由 Digital Equipment Corporation (DEC) 在 1976 年开发。NFS 是第一个构建于 IP 协议之上的现代网络文件系统。</p><p><strong>NFS 存储服务的作用</strong></p><p>对于多台网站服务器，经过负载均衡调度之后用户数据分别上传到不同 web 服务器磁盘中时会出现数据不一致的问题 。</p><p>如果对多台 web 服务器均进行实时无差异的数据同步，部署会很麻烦，并且浪费磁盘空间。存储服务器的出现可以实现数据存储的统一性(即共享)，也可以节省架构服务器磁盘的成本开销(web服务器磁盘只需满足系统安装即可，存储服务器按需进行磁盘扩容)。</p><p><strong>NFS 存储服务的应用</strong></p><p>对于中小型企业，采用 NFS 或者 Samba 即可充分满足数据存储的应用。对于中大型企业，建议采用分布式存储MooseFS(mfs)、GlusterFS、FastDFS或者专业硬件存储 EMC (戴尔)。</p><p>在企业集群架构的工作场景中，NFS 网络文件系统一般被用来存储共享视频、图片、附件等静态资源文件，通常网站用户上传的文件都会放在 NFS 共享里。</p><p>共享存储的位置可以通过开源软件和商业硬件实现，互联网中小型集群架构会用普通 PC 服务器配置 NFS 网络文件系统实现。硬件实现可以利用 IOE(IBM Oracle EMC) 相应的硬件设备实现，但去 IOE 正在成为互联网公司的主流。</p><p><strong>NFS 在网络文件共享服务作用总结</strong></p><ol><li>负载均衡设备会将访问流量，进行分流，但不便于文件和数据的互相访问 ；</li><li>利用服务器间的数据同步可以使用户之间数据互访，但同步管理操作过于复杂 ；</li><li>利用 NFS 服务器可以统一管理数据，是用户之间可以顺利互访。</li></ol><h3 id="二-NFS-工作原理"><a href="#二-NFS-工作原理" class="headerlink" title="二. NFS 工作原理"></a>二. NFS 工作原理</h3><p><strong>实现原理</strong></p><p>首先存储服务器需要与客户端建立网络连接，之后实现挂载，此时数据存储到客户端挂载点目录时，实际上会通过网络传输存储到存储服务器对应的目录中。数据存储时属主和属组信息可能会发生变化，需要注意存储目录的权限。</p><p><strong>RPC 服务</strong></p><p>NFS 传输数据时使用的端口会随机选择，其中CentOS 5.x 的随机端口都小于 1024，而 CentOS 6.x 的随机端口都是较大的。NFS 客户端通过 RPC (中文意思是远程过程调用，英文 Remote Procedure Call 简称 RPC) 协议/服务来与服务端进行连接以此提供服务。</p><p>NFS 的 RPC 服务主要的功能就是记录每个 NFS 功能所对应的端口号，并且在 NFS 客户端请求时将该端口和功能对应的信息传递给请求数据的 NFS 客户端，从而确保客户端可以连接到正确的 NFS 端口上，达到实现数据传输交互的目的。</p><p>当 NFS 服务器端启动服务时会随机取用若干端口，并主动向 RPC 服务注册取用的相关端口及功能信息，RPC 服务就知道 NFS 每个端口对应的 NFS 功能了，然后 RPC 服务使用固定的 111 端口来监听 NFS 客户端提交的请求，并将正确的 NFS 端口信息回复给请求的 NFS客户端。</p><p>在启动 NFS Server 之前，首先要启动 RPC 服务 (Centos 5.8 下为 portmap 服务，Centos 6.6下为 rpcbind 服务)。如果 RPC 服务重新启动，原来已经注册好的 NFS 端口数据就会丢失，因此，此时 RPC 服务管理的 NFS 程序也需要重新启动以重新向 RPC 注册。</p><p>一般修改 NFS 配置文件后，是不需要重启 NFS 的，直接在命令行执行 <code>exportfs -rv</code> 即可使修改的 <code>/etc/exports</code> 生效。</p><p><strong>NFS 访问存取原理</strong></p><ol><li>首先用户访问网站程序，由程序在 NFS 客户端上发出存取 NFS 文件的请求，这时 NFS 客户端 (即执行程序的服务器) 的 RPC 服务 (rpcbind 服务) 就会通过网络向 NFS 服务器端的 RPC 服务 (rpcbind 服务) 的 111 端口发出 NFS 文件存取功能的询问请求。</li><li>NFS 服务器端的 RPC 服务 (rpcbind 服务) 找到对应的已注册的 NFS 端口后，通知 NFS客户端的 RPC 服务 (rpcbind 服务) 。</li><li>此时 NFS 客户端获取到正确的端口，并与 NFS daemon 联机存取数据。</li><li>NFS 客户端把数据存取成功后，返回给前端访问程序，告知用户存取结果，作为网站用户，就完成了一次存取操作。</li><li>总结：NFS 需要有 RPC 服务的协助才能成功对外提供服务。要使用 NFS 时，都需要首先启动 RPC 服务，NFS 服务必须在 RPC 服务启动之后启动，客户端无需启动 NFS 服务，但需要启动 RPC 服务。</li></ol><p><strong>NFS 服务常见进程详解</strong></p><p>运行 NFS 服务默认需要启动的服务或进程至少有：NFS quotas (rpc.rquotad) ，NFS daemon (nfsd) ，NFS mount (rpc.mountd) 。</p><p>NFS 服务的主要任务是共享文件系统数据，而文件系统数据的共享离不开权限问题。所以NFS 服务器启动时最少需要两个不同的进程，一个是管理 NFS 客户端是否能够登入的 rpc.nfsd 主进程，另一个用于管理 NFS 客户端是否能够取得对应权限的 rpc.mountd 进程。如果还需要管理磁盘配额，则 NFS 还要再加载 rpc.rquotad 进程。</p><h3 id="三-NFS-部署"><a href="#三-NFS-部署" class="headerlink" title="三. NFS 部署"></a>三. NFS 部署</h3><p><strong>服务端(172.16.1.31)部署过程：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装软件</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建用于存储的目录，同时调整属主属组信息</span></span><br><span class="line">mkdir /data</span><br><span class="line">chown nfsnobody. /data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 补充，为了配置方便，可以先进行 hosts 配置</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">172.16.1.7  web01 # 将其写入到 /etc/hosts 文件中</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编写配置文件 /etc/exports ，默认为空，可以通过 man exports 来查看如何配置</span></span><br><span class="line">vim /etc/exports</span><br><span class="line">/data web01(rw,sync) backup(rw,sync) # 将其写入到 /etc/exports 文件中</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动服务</span></span><br><span class="line">systemctl start nfs.service</span><br></pre></td></tr></table></figure><p><strong>客户端(172.16.1.7)部署过程：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装软件(目的是让客户端识别 nfs 文件系统类型以实现挂载)</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建挂载点，进行本地目录挂载</span></span><br><span class="line">mkdir /upload</span><br><span class="line">mount -t nfs 172.16.1.31:/data /upload</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure><p><strong>客户端挂载参数提升：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs -o fg,hard,intr,rsize=131072,wsize=131072 10.0.0.7:/data /mnt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 说明</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. <span class="built_in">fg</span> 代表客户端执行挂载时在前台执行，此时 mount 会持续尝试挂载直到成功或挂载时间超时</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. hard 使用 hard 模式挂载时，client 会一致尝试连接到 server，此时无法 umount 或者 <span class="built_in">kill</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 当使用 hard 挂载 timeout 时，如果指定 intr 参数可以在 timeout 后中断，避免出现问题时系统被 NFS 锁死</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. rsize 和 wsize 为性能参数，分别代表读出和写入的区块大小，可以提升传输能力。rsize 和 wsize 的大小最好是 1024 的倍数</span></span><br></pre></td></tr></table></figure><p><strong>客户端挂载参数优化 (mount 挂载优化内容)：</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有关系统安全挂载参数选项</span></span><br><span class="line">mount -t nfs -o nosuid,noexec,nodev,rw 10.0.0.7:/data /mnt</span><br><span class="line"><span class="comment"># 禁止更新目录及文件时间戳挂载</span></span><br><span class="line">mount -t nfs -o noatime,nodiratime 10.0.0.7:/data /mnt</span><br><span class="line"><span class="comment"># 安全加优化的挂载方式</span></span><br><span class="line">mount -t nfs -o nosuid,noexec,nodev,noatime,nodiratime,rsize=131072,wsize=131072 10.0.0.7:/data /mnt</span><br></pre></td></tr></table></figure><h3 id="四-NFS-配置文件与配置参数详解"><a href="#四-NFS-配置文件与配置参数详解" class="headerlink" title="四. NFS 配置文件与配置参数详解"></a>四. NFS 配置文件与配置参数详解</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> NFS 默认配置文件路径为 /etc/exports，内容为空，需要用户自行配置</span> </span><br><span class="line">man exports # 查看官方配置说明文档，内容见下</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sample /etc/exports file</span></span><br><span class="line">/               master(rw) trusty(rw,no_root_squash)</span><br><span class="line">/projects       proj*.local.domain(rw)</span><br><span class="line">/usr            *.local.domain(ro) @trusted(rw)</span><br><span class="line">/home/joe       pc001(rw,all_squash,anonuid=150,anongid=100)</span><br><span class="line">/pub            *(ro,insecure,all_squash)</span><br><span class="line">/srv/www        -sync,rw server @trusted @external(ro)</span><br><span class="line">/foo            2001:db8:9:e54::/64(rw) 192.0.2.0/24(rw)</span><br><span class="line">/build          buildhost[0-9].local.domain(rw)</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 说明：</span></span><br><span class="line"><span class="comment"># 每一行分为三个部分</span></span><br><span class="line"><span class="comment"># 1. 指定本地存储数据的目录</span></span><br><span class="line"><span class="comment"># 2. 定义允许存储数据的主机信息，可以是ip地址、网段、主机名(需要提前进行 hosts 配置)</span></span><br><span class="line"><span class="comment"># 3. 存储服务参数配置，比较常用的有 rw、sync</span></span><br><span class="line"><span class="comment"># 总结：服务端存储目录 客户端主机1ip(参数) 客户端主机2ip(参数)</span></span><br></pre></td></tr></table></figure><p>关于 no_all_squash 的说明：假设客户端使用 linus 进行管理，如果存储服务器上不存在 linus 用户，则在存储服务器上 linus 的数据使用 linus 的 uid 和 gid 进行管理；如果存储服务器上虽然没有 linus 用户，但是存在 uid 与linus 一样的用户 zeus，那么 linus 的数据在存储服务器上使用 zeus 进行管理。</p><p><strong>参数配置图解说明如下</strong></p><p><img src="https://zeuslb.github.io/img/NFS%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%94%A8%E6%88%B7%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86%E5%9B%BE.svg" alt="NFS客户端用户映射原理图"></p><p><strong>NFS 客户端地址的配置详细说明见下</strong></p><table><thead><tr><th>客户端地址</th><th>具体地址</th><th>说明</th></tr></thead><tbody><tr><td>授权单一客户端访问 NFS</td><td>10.0.0.30</td><td>一般情况，生产环境中此配置不多</td></tr><tr><td>授权整个网段可访问 NFS</td><td>10.0.0.0/24</td><td>其中的 24 等同于 255.255.255.0，指定网段为生产环境中最常见的配置。配置简单，维护方便</td></tr><tr><td>授权整个网段可访问 NFS</td><td>10.0.0.*</td><td>指定网段的另外写法 (不推荐使用）</td></tr><tr><td>授权某个域名客户端访问</td><td>nfs.linus.com</td><td>此方法生产环境中一般情况不常用</td></tr><tr><td>授权整个域名客户端访问</td><td>*.linus.com</td><td>此方法生产环境中一般情况不常用</td></tr></tbody></table><p><strong>NFS 配置参数权限说明见下：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>rw (常用)</td><td>指定存储目录具有读写权限</td></tr><tr><td>ro</td><td>指定存储目录具有只读权限，应用场景：对于开发人员管理的服务器 (一般为测试服务器) 进行挂载操作时设置 ro 权限</td></tr><tr><td>sync (常用)</td><td>数据同步传输，会将数据直接存储到 nfs 服务器的磁盘上 (针对中小型实际 NFS 应用场景，推荐)</td></tr><tr><td>async</td><td>数据异步传输，会将数据先存储到 nfs 服务器的内存中，之后定时定量地写入到磁盘上，存在安全问题</td></tr><tr><td>all_squash</td><td>将所有用户生成的数据转换为虚拟用户 nfsnobody (uid 和 gid 默认为 65534) 进行管理</td></tr><tr><td>no_all_squash (默认)</td><td>不对所有用户生成的数据进行属主和属组的转换</td></tr><tr><td>root_squash (默认)</td><td>将 root 用户生成的数据转换为虚拟用户 nfsnobody 进行管理</td></tr><tr><td>no_root_squash</td><td>不对 root 用户生成的数据进行属主和属组的转换</td></tr><tr><td>anonuid</td><td>将权限压缩为指定 uid 用户的权限，使用时在配置参数中指定 anonuid=888</td></tr><tr><td>anongid</td><td>将权限压缩为指定 gid 用户的权限，使用时在配置参数中指定 anongid=888</td></tr></tbody></table><p>配置好 NFS 服务后，通过 <code>cat /var/lib/nfs/etab</code> 命令可以看到 NFS 配置的参数以及默认自带的参数。</p><h3 id="五-错误排查"><a href="#五-错误排查" class="headerlink" title="五. 错误排查"></a>五. 错误排查</h3><p><strong>配置文件错误排查</strong></p><p>使用 exportfs -rv 重新加载配置文件，如果发生错误即可显示出具体的错误信息。</p><p>如果挂载时出现 <code>access denied by server while mounting ...</code> 时，可能的错误是配置文件错误。</p><p><strong>rpcbind 错误排查</strong></p><p>客户端挂载无反应，可能出现的问题是 rpcbind 服务程序(远程过程调用程序)未启动(启动：systemctl start rpcbind)。当两台主机进行远程通讯时，必须的信息包括了ip地址和端口号，但是有些程序比如 nfs 会存在多端口、端口经常变化或者无端口的情况，这时可能会出现远程连接不上的问题。rpcbind 服务可以解决此问题，固定端口是 111，在进行远程时会进行统一管理进行连接。</p><p>如果出现 <code>RPC: Program not registered</code> 错误提示，一般是 RPC 服务和 NFS 的服务启动顺序错误，重启即可。</p><p>可以通过 rpcinfo -p localhost (服务端) 、rpcinfo -p 172.16.1.31 (客户端) 查看 NFS 服务是否在 RPC 上注册成功 (注册成功即 NFS 部署成功，且启动顺序无问题)。</p><p><strong>防火墙问题</strong></p><p>客户端执行 <code>showmount -e 172.16.1.31</code> 可以检查是否有可以挂载信息，如果遇到以下报错信息，大多数是因为防火墙问题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# showmount -e  172.16.1.31</span><br><span class="line">clnt_create: RPC: Port mapper failure - Unable to receive: errno 113 (No route to host)</span><br></pre></td></tr></table></figure><p><strong>卸载设备问题排查</strong></p><p>卸载挂载设备时显示 <code>device is busy</code> 时，有可能是当前目录就是挂载的 NFS 目录，也有可能是 NFS Server 挂了。对于第二种情况，只能采用 <code>umount -lf /mnt</code> (其中的参数-f 为强制卸载，参数-l 为懒惰的卸载) 进行强制卸载。</p><p><strong>其他错误排查</strong></p><p>客户端挂载错误，可能出现的问题是 hosts 配置错误，需要注意 hosts 配置更改后需要重新启动 nfs.service 服务。</p><h3 id="六-NFS-存储服务常见问题说明"><a href="#六-NFS-存储服务常见问题说明" class="headerlink" title="六. NFS 存储服务常见问题说明"></a>六. NFS 存储服务常见问题说明</h3><p><strong>自动挂载问题说明：</strong></p><p>因为临时挂载时，重启服务器会失效，所以需要实现自动挂载，配置如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fstab</span><br><span class="line">172.16.1.31:/data /upload nfs default 0 0</span><br></pre></td></tr></table></figure><p>根据系统启动流程，fstab 文件是在网络服务启动之前进行加载的，之所以挂载成功，是因为网络服务启动之后，会自动启动一个叫作 <code>remote-fs.target</code> 的服务，该服务会重新扫描 fstab 文件进行挂载，从而实现网络存储服务的挂载。</p><p>自动挂载也可以使用将挂载命令放到 <code>/etc/rc.local</code> 文件中。其缺点是偶尔可能出现开机挂载不上的问题，在实际工作环境下，处理开机自启动配置，还要对是否挂载进行监控。</p><p><strong>共享目录挂载时很卡问题说明：</strong></p><p>NFS 服务端重启之后。立刻进行挂载会出现此问题，因为 NFS 自身重启的时候，拥有无敌的时间，默认是 90 秒；在无敌时间内，是不能对共享目录进行更改的操作。</p><p>可以在系统配置 <code>/etc/sysconfig/nfs</code> 中指定了无敌时间的配置参数 (不推荐)。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NFSD_V4_GRACE=90</span><br><span class="line">NFSD_V4_LEASE=90</span><br><span class="line">NLM_GRACE_PERI0D=90</span><br></pre></td></tr></table></figure><p>服务程序建议尽量平滑重启，即使用 <code>reload</code>，而不是 restart 。</p><p><strong>出现文件句柄错误说明：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount.nfs: Stale file handle</span><br></pre></td></tr></table></figure><p>配置改变后，客户端没有进行卸载而是直接使用挂载点，解决方案为卸载后重新进行挂载即可。</p><p><strong>存储服务器中创建存储目录不要有父级与子级关系说明</strong></p><p>如果有父子关系出现，可能的现象有父级目录可以让子级目录所指定的主机进行挂载、父级目录设置权限参数会有集成关系等。</p><h3 id="七-更多参考资料"><a href="#七-更多参考资料" class="headerlink" title="七. 更多参考资料"></a>七. 更多参考资料</h3><ul><li><a target="_blank" rel="noopener" href="http://www.citi.umich.edu/projects/nfsv4/linux/">http://www.citi.umich.edu/projects/nfsv4/linux/</a></li><li><a target="_blank" rel="noopener" href="http://www.vanemery.com/Linux/NFSv4/NFSv4-no-rpcsec.html">http://www.vanemery.com/Linux/NFSv4/NFSv4-no-rpcsec.html</a></li><li><a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/linux/l-network-filesystems/">http://www.ibm.com/developerworks/cn/linux/l-network-filesystems/</a></li><li><a target="_blank" rel="noopener" href="http://www.tldp.org/HOWTO/NFS-HOWTO/index.html">http://www.tldp.org/HOWTO/NFS-HOWTO/index.html</a></li></ul></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-left"><v-icon>chevron_left</v-icon><a class="font-weight-bold text-left" href="/2020/12/15/HTTP%20%E4%B8%8E%20Nginx%20%E9%83%A8%E7%BD%B2/">HTTP 与 Nginx 部署</a></div><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/12/02/%E4%B8%8Ethis%E7%9B%B8%E5%85%B3%E7%9A%84%E9%97%AE%E9%A2%98/">this相关问题</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script type="text/javascript" src="\js\snow.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hibiki.model.json"},display:{position:"right",width:145,height:315},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html>