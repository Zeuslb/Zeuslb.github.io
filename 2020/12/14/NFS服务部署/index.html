<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/12/14/NFS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E5%88%9D%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">一. 存储服务初识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%BA%94%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-NFS-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">2. NFS 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-NFS-%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">3. NFS 部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-NFS-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">4. NFS 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="toc-number">5.</span> <span class="toc-text">5. 错误排查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">6. 存储服务常见问题说明</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/12/14/NFS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/"></a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-12-14 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-14 </span><span><v-icon color="">folder</v-icon>In:&nbsp;Uncategorized </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h2 id="一-存储服务初识"><a href="#一-存储服务初识" class="headerlink" title="一. 存储服务初识"></a>一. 存储服务初识</h2><h3 id="1-1-概念"><a href="#1-1-概念" class="headerlink" title="1.1 概念"></a>1.1 概念</h3><p>NFS 是 Network File System 的缩写，即网络文件系统，其主要功能是通过网络(局域网)实现不同主机之间的文件共享。</p><h3 id="1-2-作用"><a href="#1-2-作用" class="headerlink" title="1.2 作用"></a>1.2 作用</h3><p>对于多台网站服务器，经过负载均衡调度之后用户数据分别上传到不同 web 服务器磁盘中时会出现数据不一致的问题 。</p><p>如果对多台 web 服务器均进行实时无差异的数据同步，部署会很麻烦，并且浪费磁盘空间。存储服务器的出现可以实现数据存储的统一性(即共享)，也可以节省架构服务器磁盘的成本开销(web服务器磁盘只需满足系统安装即可，存储服务器按需进行磁盘扩容)。</p><h3 id="1-3-应用"><a href="#1-3-应用" class="headerlink" title="1.3 应用"></a>1.3 应用</h3><p>对于中小型企业，采用 NFS 或者 Samba 即可充分满足数据存储的应用。对于中大型企业，建议采用分布式存储MooseFS(mfs)、GlusterFS、或者专业硬件存储EMC(戴尔)</p><p>拓展：</p><h2 id="2-NFS-工作原理"><a href="#2-NFS-工作原理" class="headerlink" title="2. NFS 工作原理"></a>2. NFS 工作原理</h2><p>首先存储服务器需要与客户端建立网络连接，之后实现挂载，这时数据存储到客户端挂载点目录时，实际上会通过网络传输存储到存储服务器对应的目录中。数据存储时属主和属组信息可能会发生变化，需要注意存储目录的权限。</p><h2 id="3-NFS-部署"><a href="#3-NFS-部署" class="headerlink" title="3. NFS 部署"></a>3. NFS 部署</h2><p>服务端(172.16.1.31)部署过程：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装软件</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建用于存储的目录，同时调整属主属组信息</span></span><br><span class="line">mkdir /data</span><br><span class="line">chown nfsnobody. /data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 补充，为了配置方便，可以先进行 hosts 配置</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">172.16.1.7  web01 # 将其写入到 /etc/hosts 文件中</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 编写配置文件 /etc/exports ，默认为空，可以通过 man exports 来查看如何配置</span></span><br><span class="line">vim /etc/exports</span><br><span class="line">/data web01(rw,sync) backup(rw,sync) # 将其写入到 /etc/exports 文件中</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 启动服务</span></span><br><span class="line">systemctl start nfs.service</span><br></pre></td></tr></table></figure><p>客户端(172.16.1.7)部署过程：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装软件(目的是让客户端识别 nfs 文件系统类型以实现挂载)</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建挂载点，进行本地目录挂载</span></span><br><span class="line">mkdir /upload</span><br><span class="line">mount -t nfs 172.16.1.31:/data /upload</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure><h2 id="4-NFS-配置文件"><a href="#4-NFS-配置文件" class="headerlink" title="4. NFS 配置文件"></a>4. NFS 配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">man exports # 查看官方配置说明文档，内容见下</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sample /etc/exports file</span></span><br><span class="line">/               master(rw) trusty(rw,no_root_squash)</span><br><span class="line">/projects       proj*.local.domain(rw)</span><br><span class="line">/usr            *.local.domain(ro) @trusted(rw)</span><br><span class="line">/home/joe       pc001(rw,all_squash,anonuid=150,anongid=100)</span><br><span class="line">/pub            *(ro,insecure,all_squash)</span><br><span class="line">/srv/www        -sync,rw server @trusted @external(ro)</span><br><span class="line">/foo            2001:db8:9:e54::/64(rw) 192.0.2.0/24(rw)</span><br><span class="line">/build          buildhost[0-9].local.domain(rw)</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 说明：</span></span><br><span class="line"><span class="comment"># 每一行分为三个部分</span></span><br><span class="line"><span class="comment"># 1. 指定本地存储数据的目录</span></span><br><span class="line"><span class="comment"># 2. 定义允许存储数据的主机信息，可以是ip地址、网段、主机名(需要提前进行 hosts 配置)</span></span><br><span class="line"><span class="comment"># 3. 存储服务参数配置，比较常用的有 rw、sync</span></span><br><span class="line">     <span class="comment"># rw 指定存储目录具有读写权限</span></span><br><span class="line">     <span class="comment"># ro 指定存储目录具有只读权限，应用场景：对于开发人员管理的服务器(一般为测试服务器)进行挂载操作时设置 ro 权限</span></span><br><span class="line">     <span class="comment"># sync 数据同步传输，会将数据直接存储到 nfs 服务器的磁盘上(推荐，)</span></span><br><span class="line">     <span class="comment"># async 数据异步传输，会将数据先存储到 nfs 服务器的内存中，之后定时定量的存储到磁盘上，存在安全问题</span></span><br><span class="line">     <span class="comment"># all_squash # 将所有用户生成的数据转换为指定的用户进行管理(默认使用 nfsnobody )</span></span><br><span class="line">     <span class="comment"># no_all_squash # 不对所有用户生成的数据进行属主和属组的转换(需要注意此时存储目录的权限需要加写权限 o+w )</span></span><br><span class="line">     <span class="comment"># root_squash # 将 root 用户生成的数据转换为指定的用户进行管理(默认使用 nfsnobody )</span></span><br><span class="line">     <span class="comment"># no_root_squash # 不对 root 用户生成的数据进行属主和属组的转换</span></span><br><span class="line">     <span class="comment"># anonuid</span></span><br><span class="line">     <span class="comment"># anongid</span></span><br><span class="line"><span class="comment"># 总结：服务端存储目录 客户端主机1ip(参数) 客户端主机2ip(参数)</span></span><br></pre></td></tr></table></figure><p>关于no_all_squash的说明：假设客户端使用linus进行管理，如果存储服务器上不存在linus用户，则在存储服务器上linus的数据使用linus的uid和gid进行管理；如果存储服务器上虽然没有linus用户，但是存在uid与linus一样的用户zeus，那么linus的数据在存储服务器上使用zeus进行管理。</p><p>参数配置图解说明如下</p><p><img src="https://zeuslb.github.io/img/NFS%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%94%A8%E6%88%B7%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86%E5%9B%BE.svg" alt="NFS客户端用户映射原理图"></p><h2 id="5-错误排查"><a href="#5-错误排查" class="headerlink" title="5. 错误排查"></a>5. 错误排查</h2><p>客户端挂载无反应，可能出现的问题是 rpcbind 服务程序(远程过程调用程序)未启动(启动：systemctl start rpcbind)。当两台主机进行远程通讯时，必须的信息包括了ip地址和端口号，但是有些程序比如 nfs 会存在多端口、端口经常变化或者无端口的情况，这时可能会出现远程连接不上的问题。rpcbind 服务可以解决此问题，固定端口是 111，在进行远程时会进行统一管理进行连接。</p><p>排查服务端和客户端的 nfs 服务是否启动。</p><p>客户端挂载错误，可能出现的问题是 hosts 配置错误，需要注意 hosts 配置更改后需要重新启动 nfs.service 服务。</p><p>如果挂载时出现 access denied by server while mounting … 时，可能的错误是配置文件错误。</p><h2 id="6-存储服务常见问题说明"><a href="#6-存储服务常见问题说明" class="headerlink" title="6. 存储服务常见问题说明"></a>6. 存储服务常见问题说明</h2><p>因为临时挂载时，重启服务器会失效，所以需要实现自动挂载，配置如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fstab</span><br><span class="line">172.16.1.31:/data /upload nfs default 0 0</span><br></pre></td></tr></table></figure><p>根据系统启动流程，fstab 文件是在网络服务启动之前进行加载的，之所以挂载成功，是因为网络服务启动之后，会自动启动一个叫作 remote-fs.target 的服务，该服务会重新扫描 fstab 文件进行挂载，从而实现网络存储服务的挂载。</p><p><strong>问题一：存储服务不能被访问</strong></p><ol><li>服务端配置文件进行了策略阻止</li><li>防火墙阻止了网络服务</li></ol><p><strong>问题二：存储服务不能正常启动</strong></p><ol><li>与服务端配置文件错误有关</li></ol><p><strong>问题三：存储服务器中创建存储目录不要有父级与子级关系</strong></p><ol><li>父级目录可以让子级目录所指定的主机进行挂载</li><li>父级目录设置权限参数会有集成关系</li></ol><p><strong>问题四：存储服务器重启后进行挂载，创建数据时会有延迟</strong></p><ol><li>可以更改配置参数(不推荐)</li><li>服务程序建议尽量平滑重启，即使用 reload，而不是 restart</li></ol><p><strong>问题五：存储服务文件句柄错误</strong></p><ol><li>配置改变后，客户端没有进行卸载而是直接使用挂载点</li><li>解决：重新挂载</li></ol><p>排错思路</p></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/12/02/%E4%B8%8Ethis%E7%9B%B8%E5%85%B3%E7%9A%84%E9%97%AE%E9%A2%98/">this相关问题</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script type="text/javascript" src="\js\snow.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hibiki.model.json"},display:{position:"right",width:145,height:315},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html>