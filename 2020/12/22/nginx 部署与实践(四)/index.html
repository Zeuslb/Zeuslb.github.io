<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>nginx 部署与实践(四) | Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/12/22/nginx%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5(%E5%9B%9B)/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">网站架构配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF-%E6%89%8B%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">网站架构代码上线 (手动)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%88%86%E7%A6%BB"><span class="toc-number">3.</span> <span class="toc-text">网站数据库服务分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E8%B0%83%E6%95%B4%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">网站调整数据存储过程</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/12/22/nginx%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5(%E5%9B%9B)/">nginx 部署与实践(四)</a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-12-22 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-22 </span><span><v-icon color="">folder</v-icon>In:&nbsp;<a class="category-link" href="/categories/Linux/">Linux</a> </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h3 id="网站架构配置"><a href="#网站架构配置" class="headerlink" title="网站架构配置"></a>网站架构配置</h3><p><strong>nginx 服务配置</strong></p><p>目的是实现静态资源访问自己处理，动态资源访问交给 php 服务处理。</p><p>具体配置过程见下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">	root /html/www/;</span><br><span class="line">	fastcgi_index index.php; # php 服务默认处理动态资源</span><br><span class="line">	fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; # 告知 php 程序请求资源的具体地址</span><br><span class="line">	fastcgi_pass  127.0.0.1:9000; # 调取 fastcgi 接口，将 nginx 收到动态请求传输给本地 9000 端口，即传输给 php 程序</span><br><span class="line">	include fastcgi_params; # 引用加载识别fastcgi配置相关的变量文件</span><br><span class="line">	client_max_body_size 100m; # 设置上传大小限制</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$document_root</span>：root or <span class="built_in">alias</span> directive’s value <span class="keyword">for</span> the current request，即 /html/www/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$fastcgi_script_name</span>：request URI</span></span><br></pre></td></tr></table></figure><p>nginx 配置测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> php 测试文件</span></span><br><span class="line">vim /html/linus/test_php.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>php 配置</strong></p><p>目的是实现数据存储过程/实现存储大文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 编辑配置文件 /etc/php-fpm.d/www.conf</span></span><br><span class="line">vim /etc/php-fpm.d/www.conf</span><br><span class="line">user = apache # 调整为和 nginx 服务的 worker 进程用户相同/和后端存储服务目录属主信息相同</span><br><span class="line">group = apache</span><br><span class="line">listen = 127.0.0.1:9000; # 可以实现 php 与 nginx 服务分离(不同服务器)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 编辑配置文件 /etc/php.ini</span></span><br><span class="line">vim /etc/php.ini</span><br><span class="line">post_max_size = 8M # 设置 post 方式数据的最大大小</span><br><span class="line">upload_max_filesize = 2M # 设置上传数据的最大文件大小</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置时 post_max_size 大于 upload_max_filesize 为佳</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 重启服务</span></span><br><span class="line">systemctl restart php-fpm.service</span><br></pre></td></tr></table></figure><p><strong>mysql/mariadb 服务配置</strong></p><p>目的是为了实现和 php 服务进行连接，使数据可以正常地进行读写。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 给数据库的 root 用户设置密码</span></span><br><span class="line">mysqladmin -uroot password &quot;root&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 利用指定的用户和密码登录数据库</span></span><br><span class="line">mysql -uroot -proot</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. mysql关闭 DNS 反向解析</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">============================</span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br><span class="line">============================</span><br><span class="line">systemctl restart mariadb.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 测试配置是否成功(登录mysql后输入：)</span></span><br><span class="line">show variables like &quot;%skip%&quot;; </span><br><span class="line"><span class="meta">#</span><span class="bash"> skip_name_resolve 的值显示为 ON 即为配置成功</span></span><br></pre></td></tr></table></figure><p>关闭 DNS 反向解析的目的：DNS 反向解析打开时，多台 web 服务器与数据库服务器连接进行配置时均需要配置 ip 地址和对应的域名，不方便。关闭后，只需要配置可以访问数据库服务器的网段即可。</p><p>测试是否可以连接数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim test_mysql.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">	$</span><span class="bash">servername = <span class="string">&quot;localhost&quot;</span>;</span></span><br><span class="line"><span class="meta">	$</span><span class="bash">username = <span class="string">&quot;root&quot;</span>;</span></span><br><span class="line"><span class="meta">	$</span><span class="bash">password = <span class="string">&quot;root&quot;</span>;</span></span><br><span class="line"><span class="meta">	//$</span><span class="bash">link_id=mysql_connect(<span class="string">&#x27;主机名&#x27;</span>,<span class="string">&#x27;用户&#x27;</span>,<span class="string">&#x27;密码&#x27;</span>);</span></span><br><span class="line">	//mysql -u用户 -p密码 -h 主机</span><br><span class="line"><span class="meta">	$</span><span class="bash">conn = mysqli_connect(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span></span><br><span class="line">	if ($conn) &#123;</span><br><span class="line">		echo &quot;mysql successful by root !\n&quot;;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		die(&quot;Connection failed: &quot; . mysqli_connect_error());</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="网站架构代码上线-手动"><a href="#网站架构代码上线-手动" class="headerlink" title="网站架构代码上线 (手动)"></a>网站架构代码上线 (手动)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 上传代码到网站根目录</span></span><br><span class="line">rz -y 或者 wget xxx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建网站数据库/操作数据库的用户</span></span><br><span class="line">show databases # 查询服务器上的所有数据库</span><br><span class="line">create database wp_db; # 创建数据库</span><br><span class="line">grant all on wq_db.* to linus@localhost identified by &quot;linus&quot;;# 创建用户 linus 且授权(all) 管理 wq_db 的所有表</span><br><span class="line">quit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 网站页面初始化(开源) → 指定连接数据库</span></span><br></pre></td></tr></table></figure><h3 id="网站数据库服务分离"><a href="#网站数据库服务分离" class="headerlink" title="网站数据库服务分离"></a>网站数据库服务分离</h3><p><strong>目的</strong></p><p>实现 web 集群数据统一存储。</p><p><strong>分离过程</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 将数据库数据进行备份</span></span><br><span class="line">mysqldump -uroot -proot -A &gt; /tmp/web01_db.sql</span><br><span class="line">scp -rp /tmp/web01_db.sql 10.0.0.51:/tmp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 将数据迁移到独立数据库服务器上</span></span><br><span class="line">mysql -uroot -proot &lt; /tmp/web01_db.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. db 服务配置 → 使其 web 服务可以通过远程连接到数据库</span></span><br><span class="line">grant all on wq_db.* to linus@&quot;172.16.1.%&quot; identified by &quot;linus&quot;;</span><br><span class="line">select user,host from mysql.user;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. web 服务配置(修改数据库连接配置)</span></span><br><span class="line">grep -r &quot;xxx&quot; ./*</span><br><span class="line">vim ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 测试</span></span><br><span class="line">mysql -uroot -proot -h172.16.1.51</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过实际的数据库更新数据来判断是否分离成功</span></span><br></pre></td></tr></table></figure><h3 id="网站调整数据存储过程"><a href="#网站调整数据存储过程" class="headerlink" title="网站调整数据存储过程"></a>网站调整数据存储过程</h3><p><strong>服务端 (nfs 服务器) 配置过程：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建相应存储目录</span></span><br><span class="line">mkdir -p /data/wq</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建目录管理用户，且更改属主属组</span></span><br><span class="line">useradd wq -u 1000 -M -s /sbin/nologin</span><br><span class="line">chown wq. /data/wq</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 更改配置文件 (已安装 nfs 服务)</span></span><br><span class="line">vim /etc/exports</span><br><span class="line">==============================</span><br><span class="line">/data/wq 10.0.0.7(rw,sync,all_squash,anonuid=1000,anongid=1000)</span><br><span class="line">==============================</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 重启服务</span></span><br><span class="line">systemctl restart nfs.service</span><br></pre></td></tr></table></figure><p><strong>客户端 (web 服务器) 配置过程：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 将原有数据进行保存备份</span></span><br><span class="line">mv /html/linus/wp-content/uploads/* /tmp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 挂载使用 nfs (已安装 nfs 服务)</span></span><br><span class="line">mount -t nfs 10.0.0.31:/data/wq /html/linus/wp-content/uploads/</span><br><span class="line">df -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 实际操作进行配置验证</span></span><br></pre></td></tr></table></figure></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/12/19/nginx%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5(%E4%B8%89)/">nginx 部署与实践(三)</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>