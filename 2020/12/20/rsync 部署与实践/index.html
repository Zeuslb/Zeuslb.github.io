<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>rsync 部署与实践 | Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/12/20/rsync%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">一. 备份服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">二. 备份服务工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-rsync-%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">三. rsync 部署安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-rsync-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">四. rsync 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-rsync-%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="toc-number">5.</span> <span class="toc-text">五. rsync 常见命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-rsync-%E7%9A%84%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">六. rsync 的多模块配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-rsync-%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8E%92%E9%99%A4%E5%8A%9F%E8%83%BD"><span class="toc-number">7.</span> <span class="toc-text">七. rsync 的数据排除功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB-rsync-%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">8.</span> <span class="toc-text">八. rsync 的安全访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D-rsync-%E7%9A%84%E6%97%A0%E5%B7%AE%E5%BC%82%E5%90%8C%E6%AD%A5"><span class="toc-number">9.</span> <span class="toc-text">九. rsync 的无差异同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81-rsync-%E7%9A%84%E4%BC%A0%E8%BE%93%E9%99%90%E9%80%9F%E5%8A%9F%E8%83%BD"><span class="toc-number">10.</span> <span class="toc-text">十. rsync 的传输限速功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-rsync-%E7%9A%84%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">11.</span> <span class="toc-text">十一. rsync 的列表查询功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">12.</span> <span class="toc-text">十三. rsync 备份服务项目实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B-%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5"><span class="toc-number">13.</span> <span class="toc-text">十四. 实时同步</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/12/20/rsync%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5/">rsync 部署与实践</a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-12-20 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-21 </span><span><v-icon color="">folder</v-icon>In:&nbsp;<a class="category-link" href="/categories/Linux/">Linux</a> </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h3 id="一-备份服务"><a href="#一-备份服务" class="headerlink" title="一. 备份服务"></a>一. 备份服务</h3><p><strong>介绍</strong></p><p>主要用于备份服务器中重要的数据，例如系统配置文件、服务配置文件、服务日志文件(数据采集) …</p><p><strong>作用</strong></p><p>早期使用本地备份，目的是作为数据对比文件。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/hosts&#123;,.bak&#125; <span class="comment"># 编辑前进行本地备份处理</span></span><br><span class="line">diff /etc/hosts /etc/hosts.bak <span class="comment"># 不带颜色的文件对比(只显示不一样的部分)</span></span><br><span class="line">vimdiff /etc/hosts /etc/hosts.bak <span class="comment"># 带颜色的文件对比(全文显示)</span></span><br></pre></td></tr></table></figure><p>远程备份主要用于数据还原。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/hosts 172.16.1.41:/backup <span class="comment"># 使用 ssh 远程备份文件(推送数据)</span></span><br><span class="line"><span class="comment"># 问题：无法实现文件的属性时间(总是备份时的时间)</span></span><br><span class="line">scp -p /etc/hosts 172.16.1.41:/backup <span class="comment"># 使用 ssh 远程备份文件，且保持文件属性</span></span><br><span class="line"><span class="comment"># 问题：无法实现备份目录</span></span><br><span class="line">scp -pr /etc 172.16.1.41:/backup <span class="comment"># 使用 ssh 远程备份目录</span></span><br><span class="line"><span class="comment"># 问题：如何实现恢复</span></span><br><span class="line">scp -p 172.16.1.41:/backup /etc/hosts <span class="comment"># 使用 ssh 远程恢复文件(拉取数据)</span></span><br><span class="line"><span class="comment"># 问题：使用 scp 时的痛点</span></span><br><span class="line"><span class="comment"># 1. 每次备份数据均需要输入密码 → 无法实现自动化</span></span><br><span class="line"><span class="comment"># 2. 备份数据时无法进行传输限制</span></span><br><span class="line"><span class="comment"># 3. 备份数据时不同用户需要进行权限调整</span></span><br></pre></td></tr></table></figure><h3 id="二-备份服务工作原理"><a href="#二-备份服务工作原理" class="headerlink" title="二. 备份服务工作原理"></a>二. 备份服务工作原理</h3><p><strong>数据传输备份原理 (rsync)</strong></p><p>图示</p><p><img src="https://zeuslb.github.io/img/rsync%E5%A4%87%E4%BB%BD%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="rsync备份原理图"></p><p>过程见下：</p><ul><li>通过TCP三次握手建立网络连接</li><li>进行身份验证。客户端发送用户密码信息，服务端对比用户文件验证合法性</li><li>数据传输后需要进行属主和属组的变化。客户端文件属性信息统一变为服务端指定的用户信息</li></ul><p><strong>数据增量备份原理 (rsync)</strong></p><p>原理：在数据远程传输之前需要进行数据比对</p><p>比对方式有以下两种：</p><ul><li><p>根据文件SHA/MD5算法进行比对(根据文件名称以及文件内容识别文件之间的区别)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum /etc/hosts</span><br></pre></td></tr></table></figure></li><li><p>根据文件属性信息进行比对(根据权限、时间、大小信息等进行区别)</p></li></ul><p><strong>备份服务的方式</strong></p><ul><li><p>定时备份数据：编写好备份数据的脚本文件，将其放入到定时任务中即可</p></li><li><p>实时备份数据：先对目录数据变化进行监控，然后利用rsync将变化的数据进行备份</p></li></ul><h3 id="三-rsync-部署安装"><a href="#三-rsync-部署安装" class="headerlink" title="三. rsync 部署安装"></a>三. rsync 部署安装</h3><p><strong>服务端部署：</strong></p><ol><li><p>在备份服务器上安装rsync</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rsync</span><br></pre></td></tr></table></figure></li><li><p>创建管理备份目录以及数据的用户信息</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd rsync -M -s /sbin/nologin</span><br></pre></td></tr></table></figure></li><li><p>创建备份目录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /backup</span><br><span class="line">   chown rsync. /backup</span><br><span class="line">   ll /backup -d</span><br></pre></td></tr></table></figure></li><li><p>创建用户列表文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;rsync_backup:linus&#x27;</span> &gt; /etc/rsync.password</span><br><span class="line">chmod 600 /etc/rsync.password</span><br></pre></td></tr></table></figure></li><li><p>编辑配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.conf</span><br><span class="line"></span><br><span class="line">uid = rsync</span><br><span class="line">gid = rsync</span><br><span class="line">port = 873</span><br><span class="line">fake super = yes</span><br><span class="line">use chroot = no</span><br><span class="line">max connections = 200</span><br><span class="line">timeout = 300</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file = /var/run/rsync.lock</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log</span><br><span class="line">ignore errors</span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span></span><br><span class="line">list = <span class="literal">false</span></span><br><span class="line">hosts allow = 172.16.1.0/24</span><br><span class="line">hosts deny = 0.0.0.0/32</span><br><span class="line">auth users = rsync_backup</span><br><span class="line">secrets file = /etc/rsync.password</span><br><span class="line">[backup]</span><br><span class="line">comment = <span class="string">&quot;backup dir by oldboy&quot;</span></span><br><span class="line">path = /backup</span><br></pre></td></tr></table></figure></li><li><p>启动服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rsyncd</span><br><span class="line">ps -ef | grep <span class="string">&quot;rsync&quot;</span></span><br><span class="line">netstat -lntup | grep 873 <span class="comment"># 查看系统网络服务状态，可以用于查看某个服务是否开启了(该命令属于net-tools程序)，参数记忆为 -untpl</span></span><br><span class="line"><span class="comment"># -l 显示网络监听信息</span></span><br><span class="line"><span class="comment"># -n 端口信息以数字方式显示</span></span><br><span class="line"><span class="comment"># -t 显示TCP协议的信息</span></span><br><span class="line"><span class="comment"># -u 显示UDP协议的信息</span></span><br><span class="line"><span class="comment"># -p 显示服务对应的进程信息(PID/Program name)</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>客户端部署：</strong></p><ul><li><p>交互式实现数据传输</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup <span class="comment"># rsync -avz 备份文件 用户名@备份服务器ip::模块名</span></span><br></pre></td></tr></table></figure></li><li><p>免交互实现数据传输</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式一：使用文件的方式(在客户端操作)</span></span><br><span class="line"><span class="built_in">echo</span> linus &gt; /etc/rsync.password <span class="comment"># 在客户端创建密码文件</span></span><br><span class="line">chmod 600 /etc/rsync.password <span class="comment"># 更改权限</span></span><br><span class="line">rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：使用环境变量的方式(在客户端操作)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export RSYNC_PASSWORD=linus&#x27;</span> &gt;&gt; /etc/profile <span class="comment"># export 指令的作用是将一个普通变量变为环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拓展： env 命令：输出所有的环境变量</span></span><br><span class="line">env | grep RSYNC_PASSWORD</span><br></pre></td></tr></table></figure></li></ul><p><strong>rsync 方式与 scp 方式在进行文件传输时的区别</strong></p><ul><li>可以实现增量复制目录下面的数据</li><li>复制目录时，目录后面有无斜线是有区别的<ul><li>scp ：无论有无斜线均复制目录；有星号时复制目录下内容</li><li>rsync：无斜线时复制目录；有斜线时复制目录下内容</li></ul></li></ul><h3 id="四-rsync-配置文件"><a href="#四-rsync-配置文件" class="headerlink" title="四. rsync 配置文件"></a>四. rsync 配置文件</h3><p><strong>路径</strong></p><p><code>/etc/rsyncd.conf</code></p><p><strong>配置说明</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">uid = rsync <span class="comment"># 指定rsync服务备份目录或者数据信息管理的用户信息</span></span><br><span class="line">gid = rsync <span class="comment"># 指定rsync服务备份目录或者数据信息管理的用户组信息</span></span><br><span class="line">port = 873 <span class="comment"># 指定服务端口号，如果修改后客户端在使用时需要加参数 --port=xxx</span></span><br><span class="line">fake super = yes <span class="comment"># uid指令指定的用户可以伪装为管理员用户</span></span><br><span class="line">use chroot = no <span class="comment"># 提高数据备份安全性(前提：需要将备份目录权限与uid信息设置为root用户)</span></span><br><span class="line">max connections = 200 <span class="comment"># 设置最大连接数(客户端连接数量)→ 保证已有连接的传输效率</span></span><br><span class="line">timeout = 300 <span class="comment"># 设置闲置连接的会话超时时间(单位是秒)</span></span><br><span class="line">pid file = /var/run/rsyncd.pid <span class="comment"># 记录服务程序的pid文件(自动生成和删除，可以用来判断服务是否启动)，用于记录进程号码</span></span><br><span class="line">lock file = /var/run/rsync.lock <span class="comment"># 记录服务程序的锁文件</span></span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log <span class="comment"># 日志文件</span></span><br><span class="line">ignore errors <span class="comment"># 忽略错误(尽量忽略简单的异常错误，提高传输的可靠性)</span></span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span> <span class="comment"># 指定备份数据的目录是否是只读的</span></span><br><span class="line">list = <span class="literal">false</span> <span class="comment"># 列表显示备份服务模块信息</span></span><br><span class="line">hosts allow = 172.16.1.0/24 <span class="comment"># 白名单(允许客户端主机地址进行访问)</span></span><br><span class="line">hosts deny = 0.0.0.0/32 <span class="comment"># 黑名单(拒绝客户端主机地址的访问)</span></span><br><span class="line">auth users = rsync_backup <span class="comment"># 指定可以进行认证的用户(该用户不需要在系统中存在，仅在服务中做认证使用)</span></span><br><span class="line">secrets file = /etc/rsync.password <span class="comment"># 用户密码文件(格式为：username:password，权限必须是600，属主和属组为root)</span></span><br><span class="line">[backup] <span class="comment"># 模块信息，下面的内容为局部配置信息</span></span><br><span class="line">comment = <span class="string">&quot;backup dir by oldboy&quot;</span> <span class="comment"># 模块注释说明</span></span><br><span class="line">path = /backup <span class="comment"># 指定模块对应的备份目录(建议模块名和备份路径名保持一致)</span></span><br></pre></td></tr></table></figure><h3 id="五-rsync-常见命令"><a href="#五-rsync-常见命令" class="headerlink" title="五. rsync 常见命令"></a>五. rsync 常见命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 语法格式一：rsync 可以实现数据本地备份，与 cp 一致</span></span><br><span class="line">rsync /etc/hosts /backup/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 语法格式二：rsync 可以实现数据远程备份，与 scp 一致</span></span><br><span class="line">rsync -avz /etc/hosts root@172.16.1.41:/tmp # 将本地数据推送到远程主机上</span><br><span class="line">rsync -avz root@172.16.1.41:/tmp/hosts /etc # 将远程数据拉取到本地主机上</span><br><span class="line"><span class="meta">#</span><span class="bash"> 语法格式三：基于守护进程的方式实现数据传输</span></span><br><span class="line">rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup # 本地 → 远程</span><br><span class="line">rsync -avz /etc/hosts rsync://rsync_backup@172.16.1.41:888/backup # 本地 → 远程</span><br><span class="line">rsync -avz rsync_backup@172.16.1.41::backup/hosts /etc/ # 本地 → 远程</span><br><span class="line"><span class="meta">#</span><span class="bash"> 常用参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v → 显示传输的过程(定时任务中可以不需要该参数)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -z → 在传输时对文件做压缩处理</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -a → 等价于执行了 -rlptgoD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -r → 可以递归传输数据(传输目录)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l → 可以复制软链接文件(仅复制快捷方式，无意义)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -L → 可以复制软链接指向的源文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -p → 维持属性中的权限不改变</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -t → 维持属性中的修改时间不改变</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o → 维持属性中的属主不改变(仅对管理员用户生效，即配置文件中的uid和gid均需要调整为root，且fake super需要注释)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -g → 维持属性中的属组不改变</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -D → 传输设备文件时可以保持设备文件属性保持不变</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -P → 显示传输进度</span></span><br></pre></td></tr></table></figure><h3 id="六-rsync-的多模块配置"><a href="#六-rsync-的多模块配置" class="headerlink" title="六. rsync 的多模块配置"></a>六. rsync 的多模块配置</h3><p><strong>作用</strong></p><p>可以实现数据的分类存储</p><p><strong>配置方法</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端配置</span></span><br><span class="line"><span class="comment"># 1. 编写配置文件</span></span><br><span class="line">[oldgirl_backup]</span><br><span class="line">comment = <span class="string">&quot;backup dir by oldgirl&quot;</span></span><br><span class="line">path = /oldgirl_backup</span><br><span class="line">auth users = oldgirl_bak</span><br><span class="line">[oldboy_backup]</span><br><span class="line">comment = <span class="string">&quot;backup dir by oldboy&quot;</span></span><br><span class="line">path = /oldboy_backup</span><br><span class="line">auth users = oldboy_bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建备份目录</span></span><br><span class="line">mkdir /oldgirl_backup</span><br><span class="line">chown rsync. /oldgirl_backup</span><br><span class="line">mkdir /oldboy_backup</span><br><span class="line">chown rsync. /oldboy_backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 设置用户列表文件</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;oldgirl_bak:oldgirl\noldboy_bak:oldboy&quot;</span> &gt;&gt; /etc/rsync.password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 重启服务</span></span><br><span class="line">systemctl restart rsyncd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端配置</span></span><br><span class="line"><span class="comment"># 1. 配置密码文件</span></span><br><span class="line"><span class="built_in">echo</span> oldgirl &gt; /etc/oldgirl_bak_rsync_password</span><br><span class="line">chmod 600 /etc/oldgirl_bak_rsync_password</span><br><span class="line"><span class="built_in">echo</span> oldboy &gt; /etc/oldboy_bak_rsync_password</span><br><span class="line">chmod 600 /etc/oldboy_bak_rsync_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">rsync -avz /etc/hosts oldboy_bak@172.16.1.41::oldboy_backup --password-file=/etc/oldboy_bak_rsync_password</span><br><span class="line">rsync -avz /etc/hosts oldgirl_bak@172.16.1.41::oldgirl_backup --password-file=/etc/oldgirl_bak_rsync_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充说明：单个模块实现多个目录分类管理</span></span><br><span class="line">rsync -avz /etc/hosts oldboy_bak@172.16.1.41::oldboy_backup/network <span class="comment"># 直接加上/network即可，不存在会自动创建</span></span><br><span class="line"><span class="comment"># 注意：只能创建单级目录，不能创建多级目录</span></span><br></pre></td></tr></table></figure><h3 id="七-rsync-的数据排除功能"><a href="#七-rsync-的数据排除功能" class="headerlink" title="七. rsync 的数据排除功能"></a>七. rsync 的数据排除功能</h3><p><strong>作用</strong></p><p>在备份目录时，需要将目录中的某些数据排除掉</p><p><strong>配置方法</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 环境准备</span></span><br><span class="line"><span class="built_in">cd</span> data</span><br><span class="line">mkdir &#123;a..c&#125;_dir</span><br><span class="line">touch &#123;a..c&#125;_dir/file&#123;01..03&#125;.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需求：a_dir中的file01.txt不要备份</span></span><br><span class="line"><span class="comment"># 需要用到 --exclude 参数，排除多个的时候可以使用多次，注意需要使用相对路径</span></span><br><span class="line">rsync -avz /data/ oldgirl_bak@172.16.1.41::oldgirl_backup --exclude a_dir/file01.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需求：a_file整个目录排除；b_dir中的file02.txt不要备份</span></span><br><span class="line"><span class="comment"># 需要用到 --exclude-from=xxx，文件里面使用相对路径</span></span><br><span class="line">touch /tmp/rsync_exclude.txt</span><br><span class="line">vim /tmp/rsync_exclude.txt</span><br><span class="line">rsync -avz /data/ oldgirl_bak@172.16.1.41::oldgirl_backup --exclude-from /tmp/rsync_exclude.txt</span><br></pre></td></tr></table></figure><h3 id="八-rsync-的安全访问控制"><a href="#八-rsync-的安全访问控制" class="headerlink" title="八. rsync 的安全访问控制"></a>八. rsync 的安全访问控制</h3><p><strong>作用</strong></p><p>显示可以与备份服务器进行网络通讯的主机</p><p><strong>配置方法</strong></p><p>设置白名单和黑名单</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需求一：只允许172.16.1.31主机进行数据备份</span></span><br><span class="line"><span class="comment"># 方法：只配置白名单，黑名单注释使其失效</span></span><br><span class="line">hosts allow = 172.16.1.31</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需求二：仅172.16.1.31主机禁止数据备份</span></span><br><span class="line"><span class="comment"># 方法：只配置黑名单，白名单注释使其失效</span></span><br><span class="line">hosts deny = 172.16.1.31</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问控制策略：</span></span><br><span class="line"><span class="comment"># 1. 只有白名单，匹配白名单的放行，不匹配的阻止</span></span><br><span class="line"><span class="comment"># 2. 只有黑名单，匹配黑名单的阻止，不匹配的放行</span></span><br><span class="line"><span class="comment"># 3. 既有黑名单也有白名单，先匹配白名单，匹配的放行，不匹配的看黑名单。黑名单匹配的阻止，不匹配的放行</span></span><br><span class="line"><span class="comment"># 4. 既在黑名单又在白名单上，白名单优先</span></span><br></pre></td></tr></table></figure><p>访问控制策略图示</p><p><img src="https://zeuslb.github.io/img/rsync%E8%AE%BF%E9%97%AE%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5.png" alt="rsync访问黑白名单策略"></p><h3 id="九-rsync-的无差异同步"><a href="#九-rsync-的无差异同步" class="headerlink" title="九. rsync 的无差异同步"></a>九. rsync 的无差异同步</h3><p><strong>作用</strong></p><p>保证客户端数据与备份服务端的数据一致</p><p><strong>配置方法</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz /data/ oldgirl_bak@172.16.1.41::oldgirl_backup --delete</span><br></pre></td></tr></table></figure><p><strong>企业应用</strong></p><p>保证线上服务端和线下服务端的数据一致性。慎用<code>--delete</code>，如果目录不正确，则会将备份服务器或者客户端的所有内容删除。</p><h3 id="十-rsync-的传输限速功能"><a href="#十-rsync-的传输限速功能" class="headerlink" title="十. rsync 的传输限速功能"></a>十. rsync 的传输限速功能</h3><p><strong>作用</strong></p><p>防止某个主机占用过多带宽导致其他服务器无法进行数据的传输</p><p><strong>配置方法</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--bwlimit=100 <span class="comment"># 默认单位是kB/s</span></span><br></pre></td></tr></table></figure><h3 id="十一-rsync-的列表查询功能"><a href="#十一-rsync-的列表查询功能" class="headerlink" title="十一. rsync 的列表查询功能"></a>十一. rsync 的列表查询功能</h3><p><strong>配置方法</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端修改配置文件</span></span><br><span class="line">list = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端查看模块列表</span></span><br><span class="line">rsync 172.16.1.41:: </span><br></pre></td></tr></table></figure><h3 id="十三-rsync-备份服务项目实战"><a href="#十三-rsync-备份服务项目实战" class="headerlink" title="十三. rsync 备份服务项目实战"></a>十三. rsync 备份服务项目实战</h3><p><strong>项目实战方案规划</strong></p><ol><li><p>项目前言介绍(目前的痛点)</p></li><li><p>项目需求说明</p><blockquote><ol><li>所有服务器的备份目录必须都为 /backup</li><li>要备份的系统配置文件包括但不限于：</li></ol><ul><li>定时任务服务的配置文件(/var/spool/cron/root) → 适合web和nfs服务器</li><li>开机自启动的配置文件(/etc/rc.local) → 适合web和nfs服务器</li><li>日常脚本的目录(/server/scripts)</li><li>防火墙iptables的配置文件(/etc/sysconfig/iptables)</li></ul><ol start="3"><li>Web服务器站点目录假定为/var/html/www/</li><li>Web服务器访问日志路径假定为/app/logs/</li><li>服务器保留打包后的7天的备份数据即可(本地留存不能多于7天，因为太多硬盘会满)</li><li>备份服务器上,保留每周一的所有数据副本，其它要保留6个月的数据副本。</li></ol><ul><li>方案一：对周一数据进行标记</li><li>方式二：备份服务器可以单独将周一数据提取出来</li></ul><ol start="7"><li>备份服务器上,要按照备份数据服务器的内网IP为目录名称保存备份，备份的文件按照时间名字保存</li><li>需要确保备份的数据尽量完整正确，在备份服务器上对备份的数据进行检查，把备份的成功及失败结果信息发给系统管理员邮箱中</li></ol></blockquote></li><li><p>项目实施进度</p></li><li><p>项目实战部署</p></li><li><p>拓展：<code>md5sum -c check.txt</code> 的工作原理</p><ol><li>读取文件信息(读取到校验值和文件名)</li><li>根据文件内容查看数据信息</li><li>将读取文件的校验值与源check文件的校验值做对比</li></ol></li></ol><p><strong>项目实战实施部署</strong></p><ol><li><p>客户端部署(nfs01、web01)</p><ol><li><p>免交互传输数据功能：配置环境变量</p></li><li><p>编写脚本完成需求</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建脚本目录和脚本文件</span></span><br><span class="line">mkdir -p /server/scripts</span><br><span class="line">touch bachup_date.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 backup_date.sh 脚本</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 初始化变量</span></span><br><span class="line">Eth1_ip=`ip a s eth1 | awk -F <span class="string">&quot;[ /]+&quot;</span> <span class="string">&#x27;NR==3&#123;print $3&#125;&#x27;</span>`</span><br><span class="line">Date_info=`date <span class="string">&quot;+%F_星期%w&quot;</span> -d <span class="string">&quot;-1 day&quot;</span>`</span><br><span class="line"><span class="comment"># 1. 创建本地备份目录(包括ip地址)</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d /backup ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	mkdir -p /backup/<span class="variable">$Eth1_ip</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 2. 打包备份数据到本地(注意软链接文件和时间问题)</span></span><br><span class="line">tar zcfh /backup/<span class="variable">$&#123;Eth1_ip&#125;</span>/system_backup_<span class="variable">$&#123;Date_info&#125;</span>.tar.gz /var/spool/cron/root /etc/rc.local /server/scripts /etc/sysconfig/iptables &amp;&gt; /dev/null</span><br><span class="line"><span class="comment"># 3. 清除七天前的历史备份数据</span></span><br><span class="line">find /backup/<span class="variable">$&#123;Eth1_ip&#125;</span>/ -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar.gz&quot;</span> -mtime +7 -delete</span><br><span class="line"><span class="comment"># 4. 生成每天数据的校验文件</span></span><br><span class="line">find /backup/<span class="variable">$Eth1_ip</span>/ -mmin -10 -name <span class="string">&quot;*.tar.gz&quot;</span> | xargs md5sum &gt; /backup/<span class="variable">$Eth1_ip</span>/check.txt</span><br><span class="line"><span class="comment"># 5. 传输备份数据</span></span><br><span class="line">rsync -az /backup/<span class="variable">$Eth1_ip</span> linus@172.16.1.41::backup</span><br></pre></td></tr></table></figure></li><li><p>编写定时任务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * &#x2F;bin&#x2F;sh &#x2F;server&#x2F;scripts&#x2F;backup_data.sh &amp;&gt; &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure></li></ol></li><li><p>服务端部署(backup)</p><ol><li><p>部署搭建 rsync 服务</p></li><li><p>对备份的数据做完整性校验</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建脚本目录和脚本文件</span></span><br><span class="line">mkdir -p /server/scripts</span><br><span class="line">touch bachup_date.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 backup_date.sh 脚本</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 1. 校验数据完整性</span></span><br><span class="line">find /backup/ -<span class="built_in">type</span> f -name <span class="string">&quot;check.txt&quot;</span> | xargs mdssum -c &gt; /var/<span class="built_in">log</span>/backup.log</span><br><span class="line"><span class="comment"># 2. 发送邮件(校验结果信息)</span></span><br><span class="line">mail -s <span class="string">&quot;backup_check&quot;</span> 714616622@qq.com &lt; /var/<span class="built_in">log</span>/backup.log</span><br><span class="line"><span class="comment"># 3. 清理180天以前的数据</span></span><br><span class="line">find /backup/ -<span class="built_in">type</span> f -mtime +180 ! -name <span class="string">&quot;*_星期1.tar.gz&quot;</span> -delete</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># 邮件配置</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 1. 编辑配置文件 /etc/maul.rc</span></span><br><span class="line"><span class="built_in">set</span> from=714616622@qq.com smtp=smtp.qq.com     <span class="comment"># 邮件发送邮件服务器域名</span></span><br><span class="line">   <span class="built_in">set</span> smtp-auth-user=714616622@qq.com smtp-auth-password=abftwbzzphewbeah smtp-auth=login</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 2. 重启服务</span></span><br><span class="line">   systemctl restart postfix.service</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 3. 测试邮件功能</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;xxx&quot;</span> | mail -s <span class="string">&quot;标题&quot;</span> lbrunnerboy@gmail.com</span><br></pre></td></tr></table></figure></li><li><p>编写定时任务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 8 * * * /bin/sh /server/scripts/backup_server.sh &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure></li></ol></li></ol><p><strong>项目实施验收检查</strong></p><p><strong>项目实战(自己的代码)</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份服务器代码：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 数据完整性校验</span></span><br><span class="line">find /backup -<span class="built_in">type</span> f -name <span class="string">&quot;check.pw&quot;</span> | xargs md5sum -c &gt; /var/<span class="built_in">log</span>/Integrity_check</span><br><span class="line"><span class="comment"># 邮件发送</span></span><br><span class="line">mail -s <span class="string">&quot;备份数据结果&quot;</span> 446951558@qq.com &lt; /var/<span class="built_in">log</span>/Integrity_check</span><br><span class="line"><span class="comment"># 保留每周一的所有数据副本，其他保留6个月的数据副本</span></span><br><span class="line">find /backup -<span class="built_in">type</span> f ! -name <span class="string">&quot;*Monday.tar.gz&quot;</span> -mtime +180 -name -delete</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs 服务器代码：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 定义变量</span></span><br><span class="line"><span class="built_in">export</span> RSYNC_PASSWORD=linus(定时任务无法识别环境变量)</span><br><span class="line">date_info=$(date <span class="string">&quot;+%F_%A&quot;</span> -d <span class="string">&quot;-1 day&quot;</span>) <span class="comment"># 备份时间信息</span></span><br><span class="line">bak_dir=<span class="string">&quot;/backup/<span class="subst">$(/usr/sbin/ip a s eth1 | awk -F <span class="string">&quot;[ /]+&quot;</span> &#x27;NR==3&#123;print $3&#125;&#x27;)</span>&quot;</span> <span class="comment"># 备份目标目录(后面不加/的原因是需要在rsync备份时将目录及其子文件传输)</span></span><br><span class="line">bak_system_data=<span class="string">&quot;/var/spool/cron/root /etc/rc.local /server/scripts /etc/sysconfig/iptables&quot;</span> <span class="comment"># 备份数据列表(系统文件)</span></span><br><span class="line">bak_web_code=<span class="string">&quot;/var/html/www&quot;</span> <span class="comment"># 备份数据列表(代码文件)</span></span><br><span class="line">bak_web_log=<span class="string">&quot;/app/logs&quot;</span> <span class="comment"># 备份数据列表(日志文件)</span></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$bak_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$bak_dir</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 压缩数据</span></span><br><span class="line">tar zcfh <span class="variable">$bak_dir</span>/system_data_<span class="variable">$&#123;date_info&#125;</span>.tar.gz <span class="variable">$bak_system_data</span></span><br><span class="line"><span class="comment"># 删除七天前的数据</span></span><br><span class="line">find <span class="variable">$bak_dir</span> -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar.gz&quot;</span> -mtime +7 -delete</span><br><span class="line"><span class="comment"># 数据校验</span></span><br><span class="line">find <span class="variable">$bak_dir</span> -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar.gz&quot;</span> -mmin -200 | xargs md5sum &gt; <span class="variable">$bak_dir</span>/check.pw</span><br><span class="line"><span class="comment"># rsync 备份</span></span><br><span class="line">rsync -az <span class="variable">$bak_dir</span> linus@172.16.1.41::backup</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># web 服务器代码：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 定义变量</span></span><br><span class="line"><span class="built_in">export</span> RSYNC_PASSWORD=linus</span><br><span class="line">date_info=$(date <span class="string">&quot;+%F_%A&quot;</span> -d <span class="string">&quot;-1 day&quot;</span>) <span class="comment"># 备份时间信息</span></span><br><span class="line">bak_dir=<span class="string">&quot;/backup/<span class="subst">$(/usr/sbin/ip a s eth1 | awk -F <span class="string">&quot;[ /]+&quot;</span> &#x27;NR==3&#123;print $3&#125;&#x27;)</span>&quot;</span> <span class="comment"># 备份目标目录(后面不加/的原因是需要在rsync备份时将目录及其子文件传输)</span></span><br><span class="line">bak_system_data=<span class="string">&quot;/var/spool/cron/root /etc/rc.local /server/scripts /etc/sysconfig/iptables&quot;</span> <span class="comment"># 备份数据列表(系统文件)</span></span><br><span class="line">bak_web_code=<span class="string">&quot;/var/html/www&quot;</span> <span class="comment"># 备份数据列表(代码文件)</span></span><br><span class="line">bak_web_log=<span class="string">&quot;/app/logs&quot;</span> <span class="comment"># 备份数据列表(日志文件)</span></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$bak_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$bak_dir</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 压缩数据</span></span><br><span class="line">tar zcfh <span class="variable">$bak_dir</span>/system_data_<span class="variable">$&#123;date_info&#125;</span>.tar.gz <span class="variable">$bak_system_data</span></span><br><span class="line">tar zcfh <span class="variable">$bak_dir</span>/web_code_<span class="variable">$&#123;date_info&#125;</span>.tar.gz <span class="variable">$bak_web_code</span></span><br><span class="line">tar zcfh <span class="variable">$bak_dir</span>/web_log_<span class="variable">$&#123;date_info&#125;</span>.tar.gz <span class="variable">$bak_web_log</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="comment"># 删除七天前的数据</span></span><br><span class="line">find <span class="variable">$bak_dir</span> -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar.gz&quot;</span> -mtime +7 -delete</span><br><span class="line"><span class="comment"># 数据校验</span></span><br><span class="line">find <span class="variable">$bak_dir</span> -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar.gz&quot;</span> -mmin -200 | xargs md5sum &gt; <span class="variable">$bak_dir</span>/check.pw</span><br><span class="line"><span class="comment"># rsync 备份</span></span><br><span class="line">rsync -az <span class="variable">$bak_dir</span> linus@172.16.1.41::backup</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 邮件配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 编辑配置文件 /etc/maul.rc</span></span><br><span class="line"><span class="built_in">set</span> from=714616622@qq.com <span class="comment"># 指定要连接访问邮箱服务</span></span><br><span class="line"><span class="built_in">set</span> smtp=smtp.qq.com     <span class="comment"># 邮件发送邮件服务器域名</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=714616622@qq.com <span class="comment"># 邮箱账号信息</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=abftwbzzphewbeah <span class="comment"># 邮箱密码信息</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth=login <span class="comment"># 需要进行远程连接登录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 重启服务</span></span><br><span class="line">systemctl restart postfix.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试邮件功能</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xxx&quot;</span> | mail -s <span class="string">&quot;标题&quot;</span> lbrunnerboy@gmail.com</span><br><span class="line">mail -s <span class="string">&quot;标题&quot;</span> lbrunnerboy@gmail.com &lt; /etc/mailcontent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拓展</span></span><br><span class="line">mailq <span class="comment"># 查看邮件发送队列</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拓展：如何获取ip地址</span></span><br><span class="line"><span class="comment"># 1. 先在 /etc/hosts 中配置好ip映射信息</span></span><br><span class="line"><span class="comment"># 2. 使用 hostname -i 即可获取到ip地址</span></span><br></pre></td></tr></table></figure><h3 id="十四-实时同步"><a href="#十四-实时同步" class="headerlink" title="十四. 实时同步"></a>十四. 实时同步</h3><p><strong>目的</strong></p><p>确保指定备份目录中数据产生变化时及时进行传输备份</p><p><strong>实时同步应用</strong></p><p>用户上传的数据信息，建议进行无差异实时同步(用户自己删除数据属于主观行为，企业服务器无特殊需求时无需备份用户数据)</p><p><strong>如何监控数据变化</strong></p><ol><li><p>工具：inotify-tools</p></li><li><p>目的：监控目录数据变化</p></li><li><p>部署：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 安装在客户端</span></span><br><span class="line">yum install -y inotify-tools</span><br><span class="line"><span class="comment"># 2. 利用命令监控数据变化</span></span><br><span class="line">inotifywait <span class="comment"># 监控目录中数据变化</span></span><br><span class="line">inotifywatch <span class="comment"># 统计目录中数据变化的数量</span></span><br><span class="line"><span class="comment"># 3. 语法</span></span><br><span class="line">inotifywait [OPTIONS] 目录</span><br><span class="line"><span class="comment"># 4. 常见参数</span></span><br><span class="line"><span class="comment"># @&lt;file&gt;     → 等价于 exclude-from=xxx，排除操作(多个)</span></span><br><span class="line"><span class="comment"># --exclude   → 排除某个目录或文件</span></span><br><span class="line"><span class="comment"># --excludei  → 排除某个目录或文件(文件或目录名不区分大小写)</span></span><br><span class="line"><span class="comment"># -m          → 持续监控，无该参数时只监控到一次事件就会退出</span></span><br><span class="line"><span class="comment"># -r          → 递归监控，即监控指定目录的同时监控各级子目录及其文件</span></span><br><span class="line"><span class="comment"># -q          → 只显示事件变化信息(不显示提示等无关紧要的信息)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -qq         → 什么都不输出</span></span><br><span class="line"><span class="comment"># --format     → 设置监控信息输出的格式(-format &quot;%e %f %w %T&quot; → 分别代表事件、文件、目录、变化时间)</span></span><br><span class="line"><span class="comment"># --timefmt    → 设置时间格式</span></span><br><span class="line"><span class="comment"># -c          → 使用 csv 格式(标准列表信息输出格式)，使用逗号分隔</span></span><br><span class="line"><span class="comment"># -t          → 监控数据的超时时间(即只监控指定的时间，之后会停止监控)</span></span><br><span class="line"><span class="comment"># -e          → 指定监控的事件(create、delete、modify、move)，监控创建、修改、删除、移动、重命名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 事件</span></span><br><span class="line">access <span class="comment"># 文件或目录内容被读取时</span></span><br><span class="line">modify <span class="comment"># 文件或目录内容被写入时</span></span><br><span class="line">attrib <span class="comment"># 文件或目录属性被改变时</span></span><br><span class="line">close_write <span class="comment"># 文件或目录内容被关闭时(文件被改变了)</span></span><br><span class="line">close_nowrite <span class="comment"># 文件或目录内容关闭时(文件未改变)</span></span><br><span class="line">close <span class="comment"># 文件或目录内容被关闭</span></span><br><span class="line">open <span class="comment"># 文件或目录内容被打开</span></span><br><span class="line">moved_to <span class="comment"># 文件或目录从其他目录移入到监控目录</span></span><br><span class="line">moved_from <span class="comment"># 文件或目录从监控目录移出</span></span><br><span class="line">move <span class="comment"># 文件或目录移动</span></span><br><span class="line">create <span class="comment"># 创建文件或目录</span></span><br><span class="line">delete <span class="comment"># 删除文件或目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 监控目录数据信息变化：inotifywait -mrq --format &quot;%w%f&quot; -e &quot;modify,close_write,moved_to,moved_from,create,delete&quot; /backup</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>如何进行数据传输</strong></p><ol><li><p>利用脚本文件实现同步数据</p><figure class="highlight plain"><figcaption><span>sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 拓展：</span><br><span class="line"># \   → 可以将长的命令换行显示</span><br><span class="line"># while read 变量 → 实时读取输出信息的每一行</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量</span></span><br><span class="line"><span class="built_in">export</span> RSYNC_PASSWORD=linus</span><br><span class="line"></span><br><span class="line">inotifywait -mrq --format <span class="string">&quot;%w%f&quot;</span> -e <span class="string">&quot;modify,close_write,moved_to,moved_from,create,delete&quot;</span> /backup\</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> inotify_data</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	rsync -az --delete /backup/ linus@172.16.1.41::backup</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何使脚本在后台运行(前台运行时断开连接即停止)</span></span><br><span class="line">nohup sh xxx.sh &amp;</span><br><span class="line"><span class="comment"># 对于二进制或者编译安装的软件，如何管理</span></span><br><span class="line"><span class="comment"># 1. kill pid # 停止服务进程</span></span><br><span class="line"><span class="comment"># 2. kill -9 pid # 强制停止服务进程</span></span><br><span class="line"><span class="comment"># 3. killall processname  (yum install -y psmisc)(问题：只能识别进程名空格分割的前面的部分)</span></span><br><span class="line"><span class="comment"># 4. pkill -f processname (可以识别进程名空格分割的后面的部分)</span></span><br></pre></td></tr></table></figure></li><li><p>利用软件工具实现同步数据(sersync)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/wsgzao/sersync</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.下载 sersync 软件</span></span><br><span class="line">wget https://github.com/wsgzao/sersync/archive/master.zip</span><br><span class="line"><span class="comment"># 2. 解压并移动</span></span><br><span class="line">unzip master.zip</span><br><span class="line"><span class="built_in">cd</span> sersync-master/</span><br><span class="line">tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br><span class="line">mv GNU-Linux-x86/ /usr/<span class="built_in">local</span>/sersync/</span><br><span class="line"><span class="comment"># 3. 修改配置文件</span></span><br><span class="line">vim /usr/<span class="built_in">local</span>/sersync/confxml.xml</span><br><span class="line">&lt;localpath watch=<span class="string">&quot;/opt/tongbu&quot;</span>&gt;</span><br><span class="line">	&lt;remote ip=<span class="string">&quot;127.0.0.1&quot;</span> name=<span class="string">&quot;tongbu1&quot;</span>/&gt;</span><br><span class="line">	&lt;!--&lt;remote ip=<span class="string">&quot;192.168.8.39&quot;</span> name=<span class="string">&quot;tongbu&quot;</span>/&gt;--&gt;</span><br><span class="line">	&lt;!--&lt;remote ip=<span class="string">&quot;192.168.8.40&quot;</span> name=<span class="string">&quot;tongbu&quot;</span>/&gt;--&gt;</span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">&lt;rsync&gt;</span><br><span class="line">	&lt;commonParams params=<span class="string">&quot;-artuz&quot;</span>/&gt;</span><br><span class="line">	&lt;auth start=<span class="string">&quot;false&quot;</span> users=<span class="string">&quot;root&quot;</span> passwordfile=<span class="string">&quot;/etc/rsync.pas&quot;</span>/&gt;</span><br><span class="line">	&lt;userDefinedPort start=<span class="string">&quot;false&quot;</span> port=<span class="string">&quot;874&quot;</span>/&gt;&lt;!-- port=874 --&gt;</span><br><span class="line">	&lt;timeout start=<span class="string">&quot;false&quot;</span> time=<span class="string">&quot;100&quot;</span>/&gt;&lt;!-- timeout=100 --&gt;</span><br><span class="line">	&lt;ssh start=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">&lt;/rsync&gt;</span><br><span class="line"><span class="comment"># 4. 启动服务程序</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/sersync/:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">sersync2 -dro /usr/<span class="built_in">local</span>/sersync/confxml.xml</span><br><span class="line"><span class="comment"># sersync2 常见参数说明</span></span><br><span class="line">/usr/<span class="built_in">local</span>/sersync/sersync2 -h</span><br><span class="line"><span class="comment"># 参数-d:启用守护进程模式</span></span><br><span class="line"><span class="comment"># 参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍</span></span><br><span class="line"><span class="comment"># 参数-o:指定配置文件，默认使用confxml.xml文件</span></span><br></pre></td></tr></table></figure><ul><li><p>配置文件</p><p><img src="https://zeuslb.github.io/img/sersync%E9%85%8D%E7%BD%AE%E5%8F%82%E8%80%83%E5%9B%BE%E7%A4%BA.png" alt="sersync配置参考图示"></p></li><li><p>进程</p><ul><li>普通进程：执行完相应的任务即消失</li><li>守护进程：一直存在与进程中</li></ul></li></ul></li><li><p>lsyncd软件 (拓展)</p></li></ol></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-left"><v-icon>chevron_left</v-icon><a class="font-weight-bold text-left" href="/2020/12/20/nginx%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5(%E4%BA%8C)/">nginx 部署与实践(二)</a></div><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/12/17/nginx%20%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5(%E4%B8%89)/">nginx 部署与实践(三)</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script type="text/javascript" src="\js\snow.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>