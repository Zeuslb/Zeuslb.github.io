<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href))</script><link rel="shortcut icon" href="/images/fluidicon.png"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lb.css"><title>JS执行机制 | Rebom</title><meta name="generator" content="Hexo 5.2.0"></head><body><div id="app"><v-app><v-content id="page"><v-container fluid><v-row><v-col cols="2" class="d-none d-md-block"><div id="sidebar" class="float-right"><a href="/" rel="home"><v-avatar size="96"><img id="logo" src="/images/avatar.webp"></v-avatar></a><v-divider></v-divider><div class="mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn></div><v-list id="main-menu" class="font-weight-bold" flat><v-list-item href="/archives/" link><v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon><v-list-item-content>Archives</v-list-item-content></v-list-item><v-list-item href="/about/" link><v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon><v-list-item-content>About</v-list-item-content></v-list-item><v-list-item href="https://zeuslb.github.io/index.html" link><v-list-item-icon><v-icon>rss_feed</v-icon></v-list-item-icon><v-list-item-content>我的博客</v-list-item-content></v-list-item></v-list><v-divider></v-divider><div class="post-toc"><a href="/2020/02/02/JS%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/" class="toc-header">Table of Contents</a><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B8%B8%E9%A9%BB%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">一. 浏览器常驻线程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C-JS-%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6-%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">二. JS 执行机制 - 单线程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E4%B8%8E%E5%BE%AE%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">三. 宏任务与微任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9B-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">四. 代码分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%94-JS-%E5%BC%95%E6%93%8E%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">五. JS 引擎执行过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AD-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE"><span class="toc-number">6.</span> <span class="toc-text">六. 执行上下文与作用域链</span></a></li></ol></div></div><div id="footer"><div class="footer-social"><v-btn icon href="mailto:714616622@qq.com" target="_blank"><v-icon>fas fa-envelope</v-icon></v-btn><v-btn icon href="https://github.com/Zeuslb" target="_blank"><v-icon>fab fa-github</v-icon></v-btn></div><v-divider></v-divider><div class="footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></div></v-col><v-col cols="12" md="10"><v-row><v-col cols="12" md="8" align-self="end"><div id="site-header"><div id="site-title"><a href="/" rel="home">Rebom</a></div><div id="site-description"></div><div id="mobile-menu" class="d-block d-md-none"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field><div class="mobile-mini-menu"><v-btn icon href="/"><v-icon>home</v-icon></v-btn><v-btn icon href="/categories/"><v-icon>folder</v-icon></v-btn><v-btn icon href="/tags/"><v-icon>bookmark</v-icon></v-btn><v-btn icon @click="SetNightMode"><v-icon>{{ nightMode }}</v-icon></v-btn><v-btn icon href="/archives/"><v-icon>archive</v-icon></v-btn><v-btn icon href="/about/"><v-icon>account_circle</v-icon></v-btn><v-btn icon href="https://zeuslb.github.io/index.html"><v-icon>rss_feed</v-icon></v-btn></div></div></div></v-col><v-col cols="4" align-self="end" class="d-none d-md-block"><v-col align-self="end"><v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field></v-col></v-col></v-row><v-card class="elevation-2 post-card"><div class="post-header"><a class="post-header-title font-weight-medium" href="/2020/02/02/JS%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/">JS执行机制</a><div class="post-header-meta"><span><v-icon color="">event</v-icon>Posted on:&nbsp;2020-02-02 </span><span><v-icon color="">event_available</v-icon>Edited on:&nbsp;2020-12-13 </span><span><v-icon color="">folder</v-icon>In:&nbsp;Uncategorized </span><span><v-icon color="">visibility</v-icon>Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span></span></div></div><div class="post-content typo"><h5 id="一-浏览器常驻线程"><a href="#一-浏览器常驻线程" class="headerlink" title="一. 浏览器常驻线程"></a>一. 浏览器常驻线程</h5><ol><li>JS 引擎线程：也称为 JS 内核，负责解析执行 Javascript 脚本程序的主线程（例如V8引擎）</li><li>GUI 渲染线程：绘制用户界面，与 JS 主线程是互斥的<ul><li>JS 可以操作 DOM 元素，进而会影响到 GUI 的渲染</li><li>负责解析 HTML 文件构建 DOM 树，解析 CSS 结合 DOM 树渲染成 RenderObject 树，然后布局和绘制页面</li><li>即当 JS 引擎处于运行状态时，GUI 渲染线程将处于冻结状态</li></ul></li><li>HTTP 异步请求线程：处理用户的 GET、POST 等请求，等到返回结果之后将回调函数推入任务队列</li><li>定时器触发线程：setTimeout、setInterval 等待时间结束之后把执行函数推入事件队列(W3C在HTML标准中规定setTimeout低于4ms的时间间隔算为4ms)</li><li>浏览器事件处理线程：click、mouse 等交互事件发生之后将这些事件放入事件队列</li><li>总结：永远只有 JS 引擎线程在执行 JS 脚本程序，其他三个线程只负责将满足触发条件的处理函数推进事件队列，等待 JS 引擎线程执行</li></ol><h5 id="二-JS-执行机制-单线程"><a href="#二-JS-执行机制-单线程" class="headerlink" title="二. JS 执行机制 - 单线程"></a>二. JS 执行机制 - 单线程</h5><ol><li><p>单线程：同一时间只能做一件事</p></li><li><p>为什么会设计成单线程？</p><ol><li>JS 设计之初就是为了用户交互，处理 DOM</li><li>如果设计成多线程，那么同一时间多个线程同时都要修改某一个 DOM ，可能会发生冲突</li><li>如果加入锁的机制，那么会将问题更加复杂化，JS 相比其他健壮性的语言优势将很小</li></ol></li><li><p>JS 是基于单线程运行的，但是可以异步执行。一般来说这种即是单线程又是异步的语言都是基于事件来驱动的，而浏览器为 JS 提供了这种环境</p></li><li><p>事件轮询概要：</p><ol><li>先判断该任务是同步还是异步，同步的进入主线程，异步的进入 Event Table 并注册函数</li><li>当指定的事情完成后(比如拿到响应，或者定时器相应的时间到了)，Event Table 会将这个函数移入到 Event Queue 中</li><li>当主线程内的任务执行完毕为空之后，会去 Event Queue 读取相应的函数，进入主线程执行</li><li>上述的过程会不断地重复，也就是我们常说的 Event Loop(事件轮询/循环)</li></ol></li></ol><h5 id="三-宏任务与微任务"><a href="#三-宏任务与微任务" class="headerlink" title="三. 宏任务与微任务"></a>三. 宏任务与微任务</h5><ol><li><p>进入 ES6 或 Node 环境中，JS 的任务分为两种，分别是宏任务(macro-task)和微任务(micro-task)，在最新的 ECMAScript 中，微任务称为 jobs，宏任务称为 task，他们的执行顺序为：<code>宏任务(同步任务) --&gt; 微任务 --&gt; 宏任务(异步任务)</code></p></li><li><p>宏任务（macro-task）可分为同步任务和异步任务</p><ol><li>同步任务：指的是在 JS 引擎主线程上按顺序执行的任务，只有前一个任务执行完毕后，才能执行后一个任务，形成一个执行栈，即函数调用栈</li><li>异步任务：指的是不直接进入 JS 引擎主线程，而是满足触发条件时，相关的线程将该异步任务推进任务队列(task queue)，等待 JS 引擎主线程上的任务执行完毕，空闲时读取执行的任务，例如异步 Ajax，DOM 事件，setTimeout…</li></ol></li><li><p>事件循环/轮询</p><ol><li><p>事件循环可以理解成由三部分组成，分别是：</p><ul><li>主线程执行栈</li><li>异步任务等待触发</li><li>任务队列</li></ul></li><li><p>任务队列(task queue)就是以队列的数据结构对事件任务进行管理，特点是先进先出，后进后出</p></li><li><p>在JS引擎主线程执行过程中：</p><ul><li>首先执行宏任务的同步任务，在主线程上形成一个执行栈，可理解为函数调用栈</li><li>当执行栈中的函数调用到一些异步执行的API（例如异步Ajax，DOM事件，setTimeout等API），则会开启对应的线程（Http异步请求线程，事件触发线程和定时器触发线程）进行监控和控制</li><li>当异步任务的事件满足触发条件时，对应的线程则会把该事件的处理函数推进任务队列(task queue)中，等待主线程读取执行</li><li>当JS引擎主线程上的任务执行完毕，则会读取任务队列中的事件，将任务队列中的事件任务推进主线程中，按任务队列顺序执行</li><li>当JS引擎主线程上的任务执行完毕后，则会再次读取任务队列中的事件任务，如此循环，这就是事件循环（Event Loop）的过程</li></ul></li><li><p>图片理解</p><p><img src="https://xbsfcursotamandareg12br-my.sharepoint.com/personal/uhdckv3f_mail_hrka_net/Documents/%E4%BA%91%E5%9B%BE%E7%89%87/Event%20Loop.jpg"></p></li></ol></li><li><p>微任务</p><ol><li>微任务是在 es6 和 node 环境中出现的一个任务类型，微任务（micro-task）的API主要有：Promise， process.nextTick</li></ol></li><li><p>宏任务与微任务的执行流程</p><ol><li>执行宏任务中同步任务，执行结束</li><li>检查是否存在可执行的微任务，有的话执行所有微任务，然后读取任务队列的任务事件，推进主线程形成新的宏任务；没有的话则读取任务队列的任务事件，推进主线程形成新的宏任务</li><li>执行新宏任务的事件任务，再检查是否存在可执行的微任务，如此不断的重复循环</li></ol></li></ol><h5 id="四-代码分析"><a href="#四-代码分析" class="headerlink" title="四. 代码分析"></a>四. 代码分析</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;script start&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;setTimeout&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;promise1&#x27;</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;promise2&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;script end&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>分析</p><ol><li>代码块通过语法分析和预编译后，进入执行阶段，当JS引擎主线程执行到<code>console.log(&#39;script start&#39;);</code>，JS引擎主线程认为该任务是<strong>同步任务</strong>，所以立刻执行输出<code>script start</code>，然后继续向下执行；</li><li>JS引擎主线程执行到<code>setTimeout(function() &#123; console.log(&#39;setTimeout&#39;); &#125;, 0);</code>，JS引擎主线程认为setTimeout是<strong>异步任务</strong>API，则向浏览器内核进程申请开启定时器线程进行计时和控制该setTimeout任务。由于W3C在HTML标准中规定setTimeout低于4ms的时间间隔算为4ms，那么当计时到4ms时，定时器线程就把该回调处理函数推进任务队列中等待主线程执行，然后JS引擎主线程继续向下执行</li><li>JS引擎主线程执行到<code>Promise.resolve().then(function() &#123; console.log(&#39;promise1&#39;); &#125;).then(function() &#123; console.log(&#39;promise2&#39;); &#125;);</code>，JS引擎主线程认为Promise是一个<strong>微任务</strong>，这把该任务划分为微任务，等待执行</li><li>JS引擎主线程执行到<code>console.log(&#39;script end&#39;);</code>，JS引擎主线程认为该任务是<strong>同步任务</strong>，所以立刻执行输出<code>script end</code></li><li>主线程上的宏任务执行完毕，则开始检测是否存在可执行的微任务，检测到一个<strong>Promise微任务</strong>，那么立刻执行，输出<code>promise1</code>和<code>promise2</code></li><li>微任务执行完毕，主线程开始读取任务队列中的事件任务setTimeout，推入主线程形成<strong>新宏任务</strong>，然后在主线程中执行，输出<code>setTimeout</code></li></ol></blockquote><blockquote><p>结果：</p><p>script start<br>script end<br>promise1<br>promise2<br>setTimeout</p></blockquote><h5 id="五-JS-引擎执行过程"><a href="#五-JS-引擎执行过程" class="headerlink" title="五. JS 引擎执行过程"></a>五. JS 引擎执行过程</h5><ol><li>分为三个阶段，按顺序为语法分析、预编译阶段、执行阶段</li><li>语法分析：分析该js脚本代码块的语法是否正确，如果出现不正确，则向外抛出一个语法错误(SyntaxError)，停止该js代码块的执行，然后继续查找并加载下一个代码块；如果语法正确，则进入预编译阶段</li><li>预编译：</li></ol><h5 id="六-执行上下文与作用域链"><a href="#六-执行上下文与作用域链" class="headerlink" title="六. 执行上下文与作用域链"></a>六. 执行上下文与作用域链</h5></div><div style="text-align:center;color:#ccc;font-size:16px;word-spacing:6px">--- 菩提本无树，明镜亦非台，本来无一物，何处染尘埃？ <i class="fas fa-heart"></i> The End ---</div><v-divider></v-divider><div class="post-nav"><div class="post-nav-button float-left"><v-icon>chevron_left</v-icon><a class="font-weight-bold text-left" href="/2020/02/02/Vue/">Vue</a></div><div class="post-nav-button float-right"><a class="font-weight-bold text-right" href="/2020/02/02/NodeJS/">Nodejs</a><v-icon>chevron_right</v-icon></div></div></v-card><div id="mobile-footer" class="d-block d-md-none"><v-divider></v-divider><div id="mobile-footer-content"><span>&copy; 2016 - 2020 libin</span></div></div></v-col></v-row></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script><script src="https://g.csdnimg.cn/??lib/jquery/1.12.4/jquery.min.js"></script><script src="/js/main.js"></script><script async src="/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src="/js/lb.js"></script><script type="text/javascript" src="\js\snow.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>